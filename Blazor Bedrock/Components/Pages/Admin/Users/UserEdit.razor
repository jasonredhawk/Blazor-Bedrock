@page "/admin/users/add"
@page "/admin/users/edit/{UserId}"
@using Blazor_Bedrock.Services.UserManagement
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.RoleManagement
@using Blazor_Bedrock.Services.Auth
@using Blazor_Bedrock.Services.Logger
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Services.FeatureFlag
@using Blazor_Bedrock.Services.Navigation
@using Blazor_Bedrock.Data.Models
@using Blazor_Bedrock.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.Extensions.Logging
@using Microsoft.EntityFrameworkCore
@inject IUserService UserService
@inject IRoleService RoleService
@inject ITenantService TenantService
@inject IPermissionService PermissionService
@inject IFeatureFlagService FeatureFlagService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ISafeNavigationService SafeNavigation
@inject INotificationService NotificationService
@inject ILogger<UserEdit> Logger
@inject IApplicationLoggerService AppLogger
@inject ApplicationDbContext DbContext
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

<PageTitle>@(_isEdit ? "Edit User" : "Add User")</PageTitle>

<div class="container mt-4" style="max-width: 800px;">
    <h4 class="mb-4">@(_isEdit ? "Edit User" : "Add User")</h4>
    
    <div class="card shadow">
        <div class="card-body p-4">
            @if (_isInitialized && (_user != null || !_isEdit) && _availableRoles.Any())
            {
                <EditForm Model="@_userModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" @bind="_userModel.FirstName" required />
                    </div>
                    
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" @bind="_userModel.LastName" required />
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" @bind="_userModel.Email" required disabled="@_isEdit" />
                        @if (!_isEdit)
                        {
                            <small class="form-text text-muted">Enter the email of an existing user to add them to this organization.</small>
                        }
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" @bind="_userModel.IsActive" disabled="@(_isEdit && _isSuperAdmin)" />
                        <label class="form-check-label @(_isEdit && _isSuperAdmin ? "text-muted" : "")" for="isActive">
                            Active
                            @if (_isEdit && _isSuperAdmin)
                            {
                                <small class="text-muted d-block ms-4">(Cannot be changed - Organization Creator must remain active)</small>
                            }
                        </label>
                    </div>
                    
                    <h6 class="mb-2">Roles</h6>
                    <div class="mb-4">
                        @foreach (var role in _availableRoles)
                        {
                            var roleId = role.Id;
                            var isAdminRole = roleId == _adminRoleId;
                            // Only apply SuperAdmin protection when editing existing users who are SuperAdmin
                            var isSuperAdminProtected = _isEdit && isAdminRole && _isSuperAdmin;
                            var isDisabled = isSuperAdminProtected;
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" 
                                       id="role-@roleId" 
                                       checked="@IsRoleChecked(roleId)"
                                       disabled="@isDisabled"
                                       @onchange="@((ChangeEventArgs e) => SetRoleChecked(roleId, e.Value?.ToString() == "True"))" />
                                <label class="form-check-label @(isDisabled ? "text-muted" : "")" for="role-@roleId">
                                    @role.Name
                                    @if (isSuperAdminProtected)
                                    {
                                        <small class="text-muted d-block ms-4">(Cannot be changed - Organization Creator)</small>
                                    }
                                </label>
                            </div>
                        }
                    </div>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-secondary" @onclick="NavigateBack">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
            else
            {
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string? UserId { get; set; }
    
    private bool _isEdit => !string.IsNullOrEmpty(UserId);
    private ApplicationUser? _user;
    private UserModel _userModel = new();
    private List<ApplicationRole> _availableRoles = new();
    private HashSet<string> _selectedRoleIds = new HashSet<string>();
    private bool _isLoading = false;
    private bool _isInitialized = false;
    private bool _isSuperAdmin = false;
    private string? _adminRoleId = null;

    private class UserModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
    }

    private bool IsRoleChecked(string roleId)
    {
        return _selectedRoleIds.Contains(roleId);
    }


    private async Task<bool> IsSuperAdminAsync(string userId)
    {
        // Never check SuperAdmin status for new users (only for existing users being edited)
        if (!_isEdit || string.IsNullOrEmpty(userId))
            return false;

        var tenantId = TenantService.GetCurrentTenantId();
        if (!tenantId.HasValue)
            return false;

        // Verify user exists in database before checking SuperAdmin status
        var userExists = await DbSync.ExecuteAsync(async () =>
        {
            return await DbContext.Users.AnyAsync(u => u.Id == userId);
        });

        if (!userExists)
            return false;

        return await DbSync.ExecuteAsync(async () =>
        {
            // Find the Admin role
            var adminRole = await DbContext.Roles.FirstOrDefaultAsync(r => r.Name == "Admin");
            if (adminRole == null)
                return false;

            // Check if this user has Admin role for this tenant
            var hasAdminRole = await DbContext.UserRoles
                .AnyAsync(ur => ur.UserId == userId && ur.RoleId == adminRole.Id && ur.TenantId == tenantId.Value);
            
            if (!hasAdminRole)
                return false;

            // Check if this user is the first user to join the tenant (the organization creator)
            // This is the most reliable way to identify the SuperAdmin
            var firstUserTenant = await DbContext.UserTenants
                .Where(ut => ut.TenantId == tenantId.Value)
                .OrderBy(ut => ut.JoinedAt)
                .ThenBy(ut => ut.UserId) // Secondary sort for consistency
                .FirstOrDefaultAsync();

            // User is SuperAdmin only if they were the first user to join the tenant
            // This identifies the organization creator
            return firstUserTenant != null && firstUserTenant.UserId == userId;
        });
    }

    private async Task SetRoleChecked(string roleId, bool isChecked)
    {
        // For new users, always allow all changes (they can't be SuperAdmin)
        if (!_isEdit || _user == null)
        {
            if (isChecked)
            {
                _selectedRoleIds.Add(roleId);
            }
            else
            {
                _selectedRoleIds.Remove(roleId);
            }
            StateHasChanged();
            return;
        }

        // For existing users, check SuperAdmin protection
        var isAdminRole = roleId == _adminRoleId;

        // Prevent SuperAdmin from unchecking Admin role (only for existing users who are SuperAdmin)
        if (isAdminRole && _isSuperAdmin && !isChecked)
        {
            await NotificationService.ShowWarningAsync("The Organization Creator cannot remove their Admin role. This ensures there is always an administrator for the organization.");
            return;
        }
        
        // For other users (non-SuperAdmin), Admin role can be toggled on/off freely

        if (isChecked)
        {
            _selectedRoleIds.Add(roleId);
        }
        else
        {
            _selectedRoleIds.Remove(roleId);
        }
        StateHasChanged();
    }

    private bool _featureDisabled = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if Users feature is enabled
        var isEnabled = await FeatureFlagService.IsEnabledAsync("Users_Enabled");
        if (!isEnabled)
        {
            _featureDisabled = true;
            return;
        }

        // Check permission
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var tenantId = TenantService.GetCurrentTenantId();
            
            if (!string.IsNullOrEmpty(userId) && tenantId.HasValue)
            {
                var requiredPermission = _isEdit ? "Users.Edit" : "Users.Add";
                var hasPermission = await PermissionService.UserHasPermissionAsync(userId, tenantId.Value, requiredPermission);
                
                if (!hasPermission)
                {
                    await NotificationService.ShowErrorAsync($"You do not have permission to {(_isEdit ? "edit" : "add")} users.");
                    SafeNavigation.NavigateTo("/admin/users");
                    return;
                }
            }
            else
            {
                SafeNavigation.NavigateTo("/");
                return;
            }
        }
        else
        {
            SafeNavigation.NavigateTo("/auth/login");
            return;
        }

        var tenantIdForData = TenantService.GetCurrentTenantId();
        if (!tenantIdForData.HasValue)
        {
            await NotificationService.ShowErrorAsync("No tenant selected");
            SafeNavigation.NavigateTo("/");
            return;
        }

        // Load available roles first
        Logger.LogInformation("[UserEdit] Loading available roles for tenant {TenantId}", tenantIdForData.Value);
        _availableRoles = await RoleService.GetRolesAsync(tenantIdForData);
        Logger.LogInformation("[UserEdit] Loaded {Count} available roles: {Roles}", 
            _availableRoles.Count, 
            string.Join(", ", _availableRoles.Select(r => $"{r.Name}({r.Id})")));
        AppLogger.Log(LogLevel.Information, $"UserEdit: Loaded {_availableRoles.Count} available roles", "UserEdit");
        
        // Find Admin role ID
        var adminRole = _availableRoles.FirstOrDefault(r => r.Name == "Admin");
        _adminRoleId = adminRole?.Id;
        
        // Initialize selected role IDs
        _selectedRoleIds.Clear();
        
        // Ensure _isSuperAdmin is false for new users
        if (!_isEdit)
        {
            _isSuperAdmin = false;
        }

        if (_isEdit && !string.IsNullOrEmpty(UserId))
        {
            Logger.LogInformation("[UserEdit] Loading user data for UserId: {UserId}", UserId);
            // Load user data
            _user = await UserService.GetUserAsync(UserId);
            if (_user != null)
            {
                Logger.LogInformation("[UserEdit] User loaded: {Email}, IsActive: {IsActive}", _user.Email, _user.IsActive);
                AppLogger.Log(LogLevel.Information, $"UserEdit: User loaded - Email: {_user.Email}, IsActive: {_user.IsActive}", "UserEdit");
                
                // Set user model with explicit IsActive value
                _userModel = new UserModel
                {
                    FirstName = _user.FirstName ?? string.Empty,
                    LastName = _user.LastName ?? string.Empty,
                    Email = _user.Email ?? string.Empty,
                    IsActive = _user.IsActive // This should be true if user is active
                };
                Logger.LogInformation("[UserEdit] User loaded - IsActive from DB: {DbIsActive}, UserModel.IsActive: {ModelIsActive}", 
                    _user.IsActive, _userModel.IsActive);
                AppLogger.Log(LogLevel.Information, 
                    $"UserEdit: User loaded - IsActive from DB: {_user.IsActive}, UserModel.IsActive: {_userModel.IsActive}", 
                    "UserEdit");
                
                // Force state update to ensure checkbox reflects the value
                StateHasChanged();

                // Load user's roles from database - this is the critical query
                Logger.LogInformation("[UserEdit] Loading user roles for UserId: {UserId}, TenantId: {TenantId}", UserId, tenantIdForData.Value);
                var userRoles = await UserService.GetUserRolesAsync(UserId, tenantIdForData.Value);
                
                Logger.LogInformation("[UserEdit] Loaded {Count} user roles: {Roles}", 
                    userRoles.Count, 
                    string.Join(", ", userRoles.Select(r => $"{r.Name}({r.Id})")));
                AppLogger.Log(LogLevel.Information, $"UserEdit: Loaded {userRoles.Count} user roles from database", "UserEdit");
                
                // Set selected role IDs
                _selectedRoleIds = userRoles
                    .Where(r => !string.IsNullOrEmpty(r.Id))
                    .Select(r => r.Id)
                    .ToHashSet();
                    
                Logger.LogInformation("[UserEdit] Selected role IDs set: {RoleIds}", 
                    string.Join(", ", _selectedRoleIds));
                AppLogger.Log(LogLevel.Information, 
                    $"UserEdit: Selected role IDs initialized with {_selectedRoleIds.Count} roles", 
                    "UserEdit");
                
                // Check if user is SuperAdmin (organization creator)
                _isSuperAdmin = await IsSuperAdminAsync(UserId);
                Logger.LogInformation("[UserEdit] User is SuperAdmin: {IsSuperAdmin}", _isSuperAdmin);
                
                // Ensure SuperAdmin is always active
                if (_isSuperAdmin && !_userModel.IsActive)
                {
                    Logger.LogWarning("[UserEdit] SuperAdmin was inactive - auto-activating");
                    _userModel.IsActive = true;
                    _user.IsActive = true;
                }
                
                // Ensure Admin role is always selected for SuperAdmin only
                if (_isSuperAdmin && _adminRoleId != null && !_selectedRoleIds.Contains(_adminRoleId))
                {
                    Logger.LogWarning("[UserEdit] SuperAdmin missing Admin role - auto-adding it");
                    _selectedRoleIds.Add(_adminRoleId);
                }
                
                // Note: For other users (non-SuperAdmin), Admin role can be freely toggled on/off
                
                // Force state update
                StateHasChanged();
            }
            else
            {
                Logger.LogWarning("[UserEdit] User not found for UserId: {UserId}", UserId);
                AppLogger.Log(LogLevel.Warning, $"UserEdit: User not found for UserId: {UserId}", "UserEdit");
                // User not found - all roles unchecked
                _selectedRoleIds.Clear();
            }
        }
        else
        {
            Logger.LogInformation("[UserEdit] Creating new user - all roles unchecked");
            // For new users, all roles are unchecked (already initialized above)
            _selectedRoleIds.Clear();
        }
        
        Logger.LogInformation("[UserEdit] Final state - Selected roles: {Count}, UserModel.IsActive: {IsActive}, IsInitialized: {IsInitialized}", 
            _selectedRoleIds.Count, _userModel.IsActive, _isInitialized);
        
        // Log selected roles
        foreach (var roleId in _selectedRoleIds)
        {
            var role = _availableRoles.FirstOrDefault(r => r.Id == roleId);
            Logger.LogInformation("[UserEdit] Selected role: {RoleName} ({RoleId})", role?.Name ?? "Unknown", roleId);
        }
        
        AppLogger.Log(LogLevel.Information, 
            $"UserEdit: Initialization complete - {_selectedRoleIds.Count} roles selected, UserModel.IsActive: {_userModel.IsActive}", 
            "UserEdit");
        
        _isInitialized = true;
        
        Logger.LogInformation("[UserEdit] About to call StateHasChanged - Selected roles: {Count}", _selectedRoleIds.Count);
        StateHasChanged();
        
        Logger.LogInformation("[UserEdit] StateHasChanged called, component should re-render");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _featureDisabled)
        {
            await Task.Delay(100);
            SafeNavigation.NavigateTo("/?error=" + Uri.EscapeDataString("User management feature has been disabled"));
            return;
        }
        
        if (firstRender && _isInitialized)
        {
            Logger.LogInformation("[UserEdit.OnAfterRenderAsync] First render after initialization");
            Logger.LogInformation("[UserEdit.OnAfterRenderAsync] UserModel.IsActive: {IsActive}", _userModel.IsActive);
            Logger.LogInformation("[UserEdit.OnAfterRenderAsync] Available roles count: {Count}", _availableRoles.Count);
            Logger.LogInformation("[UserEdit.OnAfterRenderAsync] Selected roles count: {Count}", _selectedRoleIds.Count);
            
            foreach (var role in _availableRoles)
            {
                var isChecked = IsRoleChecked(role.Id);
                Logger.LogInformation("[UserEdit.OnAfterRenderAsync] Role '{RoleName}' (ID: {RoleId}) - IsChecked: {IsChecked}", 
                    role.Name, role.Id, isChecked);
                AppLogger.Log(LogLevel.Information, 
                    $"UserEdit.OnAfterRenderAsync: Role '{role.Name}' (ID: {role.Id}) - IsChecked: {isChecked}", 
                    "UserEdit");
            }
            
            // If checkboxes aren't showing correctly, force another state update
            if (_selectedRoleIds.Any())
            {
                Logger.LogInformation("[UserEdit.OnAfterRenderAsync] Forcing StateHasChanged because we have selected roles");
                StateHasChanged();
            }
            
            AppLogger.Log(LogLevel.Information, 
                $"UserEdit.OnAfterRenderAsync: First render - UserModel.IsActive: {_userModel.IsActive}, Selected roles: {string.Join(", ", _selectedRoleIds.Select(id => _availableRoles.FirstOrDefault(r => r.Id == id)?.Name ?? "Unknown"))}", 
                "UserEdit");
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task HandleSubmit()
    {
        _isLoading = true;
        try
        {
            var tenantId = TenantService.GetCurrentTenantId();
            if (!tenantId.HasValue)
            {
                await NotificationService.ShowErrorAsync("No tenant selected");
                return;
            }

            if (_isEdit && _user != null)
            {
                _user.FirstName = _userModel.FirstName;
                _user.LastName = _userModel.LastName;
                
                // Prevent SuperAdmin from being deactivated
                if (_isSuperAdmin && !_userModel.IsActive)
                {
                    await NotificationService.ShowErrorAsync("The Organization Creator cannot be deactivated. This ensures there is always an active administrator.");
                    _userModel.IsActive = true; // Reset to active
                    _user.IsActive = true;
                }
                else
                {
                    _user.IsActive = _userModel.IsActive;
                }
                
                var result = await UserService.UpdateUserAsync(_user);
                if (result.Succeeded)
                {
                    Logger.LogInformation("[UserEdit.HandleSubmit] User updated, now updating roles. Selected roles count: {Count}", _selectedRoleIds.Count);
                    
                    // Update roles - get current roles first
                    var currentRoles = await UserService.GetUserRolesAsync(_user.Id, tenantId.Value);
                    var currentRoleIds = currentRoles.Select(r => r.Id).ToHashSet();
                    
                    Logger.LogInformation("[UserEdit.HandleSubmit] Current roles in DB: {RoleIds}", string.Join(", ", currentRoleIds));
                    Logger.LogInformation("[UserEdit.HandleSubmit] Selected roles from UI: {RoleIds}", string.Join(", ", _selectedRoleIds));

                    // Remove roles that are no longer selected (with safeguards)
                    var rolesToRemove = currentRoles.Where(r => !_selectedRoleIds.Contains(r.Id)).ToList();
                    Logger.LogInformation("[UserEdit.HandleSubmit] Roles to remove: {Count}", rolesToRemove.Count);
                    
                    foreach (var role in rolesToRemove)
                    {
                        // Prevent removing Admin role from SuperAdmin only
                        if (role.Name == "Admin" && _isSuperAdmin)
                        {
                            Logger.LogWarning("[UserEdit.HandleSubmit] Attempted to remove Admin role from SuperAdmin - blocked");
                            await NotificationService.ShowErrorAsync("Cannot remove Admin role from the Organization Creator. This ensures there is always an administrator.");
                            // Re-add Admin role to selected roles to keep it checked
                            _selectedRoleIds.Add(role.Id);
                            continue;
                        }
                        
                        // Allow removing Admin role from other users (not SuperAdmin)
                        
                        Logger.LogInformation("[UserEdit.HandleSubmit] Removing role: {RoleName} ({RoleId})", role.Name, role.Id);
                        var removeResult = await UserService.RemoveRoleFromUserAsync(_user.Id, role.Id, tenantId.Value);
                        if (!removeResult)
                        {
                            Logger.LogWarning("[UserEdit.HandleSubmit] Failed to remove role: {RoleName}", role.Name);
                            await NotificationService.ShowWarningAsync($"Failed to remove role: {role.Name}");
                        }
                        else
                        {
                            Logger.LogInformation("[UserEdit.HandleSubmit] Successfully removed role: {RoleName}", role.Name);
                        }
                    }

                    // Add new roles that are selected but not currently assigned
                    var rolesToAdd = _selectedRoleIds.Where(id => !currentRoleIds.Contains(id)).ToList();
                    Logger.LogInformation("[UserEdit.HandleSubmit] Roles to add: {Count}", rolesToAdd.Count);
                    foreach (var roleId in rolesToAdd)
                    {
                        var role = _availableRoles.FirstOrDefault(r => r.Id == roleId);
                        Logger.LogInformation("[UserEdit.HandleSubmit] Adding role: {RoleName} ({RoleId})", role?.Name ?? "Unknown", roleId);
                        var addResult = await UserService.AssignRoleToUserAsync(_user.Id, roleId, tenantId.Value);
                        if (!addResult)
                        {
                            Logger.LogWarning("[UserEdit.HandleSubmit] Failed to assign role: {RoleId}", roleId);
                            await NotificationService.ShowWarningAsync($"Failed to assign role");
                        }
                        else
                        {
                            Logger.LogInformation("[UserEdit.HandleSubmit] Successfully added role: {RoleName}", role?.Name ?? "Unknown");
                        }
                    }

                    Logger.LogInformation("[UserEdit.HandleSubmit] Role update complete. Navigating to user list.");
                    await NotificationService.ShowSuccessAsync("User updated successfully");
                    SafeNavigation.NavigateTo("/admin/users");
                }
                else
                {
                    await NotificationService.ShowErrorAsync($"Error: {string.Join(", ", result.Errors.Select(e => e.Description))}");
                }
            }
            else
            {
                // Find existing user by email
                var user = await UserManager.FindByEmailAsync(_userModel.Email);
                if (user == null)
                {
                    await NotificationService.ShowErrorAsync($"User with email '{_userModel.Email}' not found. Please ensure the user has created an account first.");
                    return;
                }

                // Check if user is already in this tenant
                var existingUserTenant = await DbSync.ExecuteAsync(async () =>
                {
                    return await DbContext.UserTenants
                        .AnyAsync(ut => ut.UserId == user.Id && ut.TenantId == tenantId.Value);
                });

                if (existingUserTenant)
                {
                    await NotificationService.ShowErrorAsync($"User with email '{_userModel.Email}' is already a member of this organization.");
                    return;
                }

                // Add user to tenant
                var added = await UserService.AssignUserToTenantAsync(user.Id, tenantId.Value);
                if (!added)
                {
                    await NotificationService.ShowErrorAsync("Failed to add user to organization.");
                    return;
                }

                // Assign roles from selected role IDs
                foreach (var roleId in _selectedRoleIds)
                {
                    await UserService.AssignRoleToUserAsync(user.Id, roleId, tenantId.Value);
                }

                await NotificationService.ShowSuccessAsync("User added to organization successfully");
                SafeNavigation.NavigateTo("/admin/users");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void NavigateBack()
    {
        SafeNavigation.NavigateTo("/admin/users");
    }

}
