@page "/admin/roles/create"
@page "/admin/roles/edit/{RoleId}"
@using Blazor_Bedrock.Services.RoleManagement
@using Blazor_Bedrock.Services.Auth
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.FeatureFlag
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IRoleService RoleService
@inject IPermissionService PermissionService
@inject ITenantService TenantService
@inject IFeatureFlagService FeatureFlagService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject INotificationService NotificationService
@rendermode InteractiveServer

<PageTitle>@(_isEdit ? "Edit Role" : "Create Role")</PageTitle>

<div class="container mt-4" style="max-width: 800px;">
    <h4 class="mb-4">@(_isEdit ? "Edit Role" : "Create Role")</h4>
    
    <div class="card shadow">
        <div class="card-body p-4">
            @if (_role != null || !_isEdit)
            {
                <EditForm Model="@_roleModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label for="roleName" class="form-label">Role Name</label>
                        <input type="text" class="form-control" id="roleName" @bind="_roleModel.Name" required disabled="@(_isEdit && _role?.IsSystemRole == true)" />
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" @bind="_roleModel.Description"></textarea>
                    </div>
                    
                    <h6 class="mb-2">Permissions</h6>
                    <div class="mb-4" style="max-height: 400px; overflow-y: auto;">
                        @foreach (var category in _permissionsByCategory)
                        {
                            <div class="mb-3">
                                <h6 class="text-muted small mb-2">@category.Key</h6>
                                @foreach (var permission in category.Value)
                                {
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="permission-@permission.Id" 
                                               checked="@IsPermissionSelected(permission.Id)"
                                               @onchange="@((ChangeEventArgs e) => TogglePermission(permission.Id, e.Value?.ToString() == "True"))" />
                                        <label class="form-check-label" for="permission-@permission.Id">
                                            @permission.Name
                                            @if (!string.IsNullOrEmpty(permission.Description))
                                            {
                                                <small class="text-muted d-block ms-4">@permission.Description</small>
                                            }
                                        </label>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-secondary" @onclick="NavigateBack">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
            else
            {
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string? RoleId { get; set; }
    
    private bool _isEdit => !string.IsNullOrEmpty(RoleId);
    private ApplicationRole? _role;
    private RoleModel _roleModel = new();
    private List<Permission> _allPermissions = new();
    private Dictionary<string, List<Permission>> _permissionsByCategory = new();
    private HashSet<int> _selectedPermissions = new();
    private bool _isLoading = false;

    private class RoleModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
    }

    private bool IsPermissionSelected(int permissionId)
    {
        return _selectedPermissions.Contains(permissionId);
    }

    private void TogglePermission(int permissionId, bool isSelected)
    {
        if (isSelected)
        {
            _selectedPermissions.Add(permissionId);
        }
        else
        {
            _selectedPermissions.Remove(permissionId);
        }
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // Check if Roles feature is enabled
        var isEnabled = await FeatureFlagService.IsEnabledAsync("Roles_Enabled");
        if (!isEnabled)
        {
            await NotificationService.ShowErrorAsync("Role management feature has been disabled.");
            Navigation.NavigateTo("/");
            return;
        }

        // Check permission
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var tenantId = TenantService.GetCurrentTenantId();
            
            if (!string.IsNullOrEmpty(userId) && tenantId.HasValue)
            {
                var requiredPermission = _isEdit ? "Roles.Edit" : "Roles.Add";
                var hasPermission = await PermissionService.UserHasPermissionAsync(userId, tenantId.Value, requiredPermission);
                
                if (!hasPermission)
                {
                    await NotificationService.ShowErrorAsync($"You do not have permission to {(_isEdit ? "edit" : "add")} roles.");
                    Navigation.NavigateTo("/admin/roles");
                    return;
                }
            }
            else
            {
                Navigation.NavigateTo("/");
                return;
            }
        }
        else
        {
            Navigation.NavigateTo("/auth/login");
            return;
        }

        _allPermissions = await PermissionService.GetAllPermissionsAsync();
        _permissionsByCategory = _allPermissions
            .GroupBy(p => p.Category ?? "General")
            .ToDictionary(g => g.Key, g => g.ToList());

        if (_isEdit && !string.IsNullOrEmpty(RoleId))
        {
            _role = await RoleService.GetRoleAsync(RoleId);
            if (_role != null)
            {
                _roleModel = new RoleModel
                {
                    Name = _role.Name ?? string.Empty,
                    Description = _role.Description
                };

                var rolePermissions = await RoleService.GetRolePermissionsAsync(RoleId);
                _selectedPermissions = rolePermissions.Select(p => p.Id).ToHashSet();
            }
        }
    }

    private async Task HandleSubmit()
    {
        _isLoading = true;
        try
        {
            var tenantId = TenantService.GetCurrentTenantId();

            if (_isEdit && _role != null)
            {
                _role.Name = _roleModel.Name;
                _role.Description = _roleModel.Description;
                
                var result = await RoleService.UpdateRoleAsync(_role);
                if (result.Succeeded)
                {
                    // Update permissions
                    var currentPermissions = await RoleService.GetRolePermissionsAsync(_role.Id);
                    var currentPermissionIds = currentPermissions.Select(p => p.Id).ToHashSet();

                    // Remove permissions
                    foreach (var permission in currentPermissions.Where(p => !_selectedPermissions.Contains(p.Id)))
                    {
                        await RoleService.RemovePermissionFromRoleAsync(_role.Id, permission.Id);
                    }

                    // Add new permissions
                    foreach (var permissionId in _selectedPermissions.Where(id => !currentPermissionIds.Contains(id)))
                    {
                        await RoleService.AssignPermissionToRoleAsync(_role.Id, permissionId);
                    }

                    await NotificationService.ShowSuccessAsync("Role updated successfully");
                    Navigation.NavigateTo("/admin/roles");
                }
                else
                {
                    await NotificationService.ShowErrorAsync($"Error: {string.Join(", ", result.Errors.Select(e => e.Description))}");
                }
            }
            else
            {
                var role = new ApplicationRole
                {
                    Name = _roleModel.Name,
                    NormalizedName = _roleModel.Name.ToUpper(),
                    Description = _roleModel.Description,
                    TenantId = tenantId,
                    IsSystemRole = false
                };

                var result = await RoleService.CreateRoleAsync(role);
                if (result.Succeeded)
                {
                    // Assign permissions
                    foreach (var permissionId in _selectedPermissions)
                    {
                        await RoleService.AssignPermissionToRoleAsync(role.Id, permissionId);
                    }

                    await NotificationService.ShowSuccessAsync("Role created successfully");
                    Navigation.NavigateTo("/admin/roles");
                }
                else
                {
                    await NotificationService.ShowErrorAsync($"Error: {string.Join(", ", result.Errors.Select(e => e.Description))}");
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/admin/roles");
    }
}
