@page "/profile/edit"
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject INotificationService NotificationService
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

<PageTitle>Edit Profile</PageTitle>

<div class="container mt-4" style="max-width: 600px;">
    <h4 class="mb-4">Edit Profile</h4>
    
    <div class="card shadow">
        <div class="card-body p-4">
            @if (_user != null)
            {
                <EditForm Model="@_profileModel" OnValidSubmit="HandleProfileSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" @bind="_profileModel.FirstName" />
                    </div>
                    
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" @bind="_profileModel.LastName" />
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" @bind="_profileModel.Email" disabled />
                    </div>
                    
                    <button type="submit" class="btn btn-primary" disabled="@_isLoading">
                        Save Changes
                    </button>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    private ApplicationUser? _user;
    private ProfileModel _profileModel = new();
    private bool _isLoading = false;

    private class ProfileModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                await DbSync.ExecuteAsync(async () =>
                {
                    _user = await UserManager.FindByIdAsync(userId);
                    if (_user != null)
                    {
                        _profileModel = new ProfileModel
                        {
                            FirstName = _user.FirstName ?? string.Empty,
                            LastName = _user.LastName ?? string.Empty,
                            Email = _user.Email ?? string.Empty
                        };
                    }
                });
            }
        }
    }

    private async Task HandleProfileSubmit()
    {
        if (_user == null) return;

        _isLoading = true;
        try
        {
            _user.FirstName = _profileModel.FirstName;
            _user.LastName = _profileModel.LastName;
            
            var result = await DbSync.ExecuteAsync(async () =>
            {
                return await UserManager.UpdateAsync(_user);
            });
            
            if (result.Succeeded)
            {
                await NotificationService.ShowSuccessAsync("Profile updated successfully");
            }
            else
            {
                await NotificationService.ShowErrorAsync($"Error: {string.Join(", ", result.Errors.Select(e => e.Description))}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }
}
