@page "/profile/edit"
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MudBlazor
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

<PageTitle>Edit Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Edit Profile</MudText>
    
    <MudTabs Elevation="0" Rounded="true" Color="Color.Primary">
        <MudTabPanel Text="Personal Information">
            <MudPaper Elevation="2" Class="pa-4 mt-4">
                @if (_user != null)
                {
                    <EditForm Model="@_profileModel" OnValidSubmit="HandleProfileSubmit">
                        <DataAnnotationsValidator />
                        
                        <MudTextField @bind-Value="_profileModel.FirstName" 
                                      Label="First Name" 
                                      Variant="Variant.Outlined" 
                                      Class="mb-4" />
                        
                        <MudTextField @bind-Value="_profileModel.LastName" 
                                      Label="Last Name" 
                                      Variant="Variant.Outlined" 
                                      Class="mb-4" />
                        
                        <MudTextField @bind-Value="_profileModel.Email" 
                                      Label="Email" 
                                      Variant="Variant.Outlined" 
                                      InputType="InputType.Email"
                                      Disabled="true"
                                      Class="mb-4" />
                        
                        <MudButton ButtonType="ButtonType.Submit" 
                                   Variant="Variant.Filled" 
                                   Color="Color.Primary"
                                   Disabled="@_isLoading">
                            Save Changes
                        </MudButton>
                    </EditForm>
                }
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private ApplicationUser? _user;
    private ProfileModel _profileModel = new();
    private bool _isLoading = false;

    private class ProfileModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                await DbSync.ExecuteAsync(async () =>
                {
                    _user = await UserManager.FindByIdAsync(userId);
                    if (_user != null)
                    {
                        _profileModel = new ProfileModel
                        {
                            FirstName = _user.FirstName ?? string.Empty,
                            LastName = _user.LastName ?? string.Empty,
                            Email = _user.Email ?? string.Empty
                        };
                    }
                });
            }
        }
    }

    private async Task HandleProfileSubmit()
    {
        if (_user == null) return;

        _isLoading = true;
        try
        {
            _user.FirstName = _profileModel.FirstName;
            _user.LastName = _profileModel.LastName;
            
            var result = await DbSync.ExecuteAsync(async () =>
            {
                return await UserManager.UpdateAsync(_user);
            });
            
            if (result.Succeeded)
            {
                Snackbar.Add("Profile updated successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error: {string.Join(", ", result.Errors.Select(e => e.Description))}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}

