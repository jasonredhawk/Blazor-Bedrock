@page "/auth/create-user-tenant"
@using Blazor_Bedrock.Data.Models
@using Blazor_Bedrock.Services.Auth
@using Blazor_Bedrock.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Blazor_Bedrock.Services.Navigation
@using MudBlazor
@attribute [AllowAnonymous]
@inject IIdentityService IdentityService
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-16">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Class="mb-4">Create Account & Organization</MudText>
        
        <MudTabs Elevation="0" Rounded="true" Color="Color.Primary" @bind-ActivePanelIndex="_activeTab">
            <MudTabPanel Text="User Information">
                <EditForm Model="@_userModel" OnValidSubmit="HandleUserSubmit" Class="mt-4">
                    <DataAnnotationsValidator />
                    
                    <MudTextField @bind-Value="_userModel.FirstName" 
                                  Label="First Name" 
                                  Variant="Variant.Outlined" 
                                  Required="true"
                                  Class="mb-4" />
                    
                    <MudTextField @bind-Value="_userModel.LastName" 
                                  Label="Last Name" 
                                  Variant="Variant.Outlined" 
                                  Required="true"
                                  Class="mb-4" />
                    
                    <MudTextField @bind-Value="_userModel.Email" 
                                  Label="Email" 
                                  Variant="Variant.Outlined" 
                                  InputType="InputType.Email"
                                  Required="true"
                                  Class="mb-4" />
                    
                    <MudTextField @bind-Value="_userModel.Password" 
                                  Label="Password" 
                                  Variant="Variant.Outlined" 
                                  InputType="InputType.Password"
                                  Required="true"
                                  Class="mb-4" />
                    
                    <MudTextField @bind-Value="_userModel.ConfirmPassword" 
                                  Label="Confirm Password" 
                                  Variant="Variant.Outlined" 
                                  InputType="InputType.Password"
                                  Required="true"
                                  Class="mb-4" />
                    
                    <MudButton ButtonType="ButtonType.Submit" 
                               Variant="Variant.Filled" 
                               Color="Color.Primary"
                               Disabled="@_isLoading">
                        Next: Organization Details
                    </MudButton>
                </EditForm>
            </MudTabPanel>
            
            <MudTabPanel Text="Organization Details">
                <EditForm Model="@_tenantModel" OnValidSubmit="HandleTenantSubmit" Class="mt-4">
                    <DataAnnotationsValidator />
                    
                    <MudTextField @bind-Value="_tenantModel.Name" 
                                  Label="Organization Name" 
                                  Variant="Variant.Outlined" 
                                  Required="true"
                                  Class="mb-4" />
                    
                    <MudTextField @bind-Value="_tenantModel.Description" 
                                  Label="Description" 
                                  Variant="Variant.Outlined" 
                                  Lines="3"
                                  Class="mb-4" />
                    
                    <MudTextField @bind-Value="_tenantModel.Domain" 
                                  Label="Domain (optional)" 
                                  Variant="Variant.Outlined" 
                                  Class="mb-4" />
                    
                    <div class="d-flex gap-2">
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Default"
                                   OnClick="() => _activeTab = 0">
                            Back
                        </MudButton>
                        <MudButton ButtonType="ButtonType.Submit" 
                                   Variant="Variant.Filled" 
                                   Color="Color.Primary"
                                   Disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Creating...</MudText>
                            }
                            else
                            {
                                <MudText>Create Account</MudText>
                            }
                        </MudButton>
                    </div>
                </EditForm>
            </MudTabPanel>
        </MudTabs>
    </MudPaper>
</MudContainer>

@code {
    private UserModel _userModel = new();
    private TenantModel _tenantModel = new();
    private bool _isLoading = false;
    private int _activeTab = 0;
    private ApplicationUser? _createdUser;

    private class UserModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private class TenantModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? Domain { get; set; }
    }

    private async Task HandleUserSubmit()
    {
        if (_userModel.Password != _userModel.ConfirmPassword)
        {
            Snackbar.Add("Passwords do not match.", Severity.Error);
            return;
        }

        if (_userModel.Password.Length < 8)
        {
            Snackbar.Add("Password must be at least 8 characters long.", Severity.Error);
            return;
        }

        var user = new ApplicationUser
        {
            UserName = _userModel.Email,
            Email = _userModel.Email,
            FirstName = _userModel.FirstName,
            LastName = _userModel.LastName,
            EmailConfirmed = true,
            IsActive = true
        };

        var result = await IdentityService.CreateUserAsync(user, _userModel.Password);
        
        if (result.Succeeded)
        {
            _createdUser = user;
            _activeTab = 1;
            Snackbar.Add("User created successfully! Now create your organization.", Severity.Success);
        }
        else
        {
            var errors = string.Join(", ", result.Errors.Select(e => e.Description));
            Snackbar.Add($"Error creating user: {errors}", Severity.Error);
        }
    }

    private async Task HandleTenantSubmit()
    {
        if (_createdUser == null)
        {
            Snackbar.Add("Please complete user information first.", Severity.Error);
            _activeTab = 0;
            return;
        }

        _isLoading = true;
        try
        {
            var tenant = new Tenant
            {
                Name = _tenantModel.Name,
                Description = _tenantModel.Description,
                Domain = _tenantModel.Domain,
                IsActive = true
            };

            DbContext.Tenants.Add(tenant);
            await DbContext.SaveChangesAsync();

            // Link user to tenant
            var userTenant = new UserTenant
            {
                UserId = _createdUser.Id,
                TenantId = tenant.Id,
                IsActive = true
            };

            DbContext.UserTenants.Add(userTenant);
            await DbContext.SaveChangesAsync();

            Snackbar.Add("Account and organization created successfully!", Severity.Success);
            Navigation.NavigateTo("/auth/login");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating organization: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}

