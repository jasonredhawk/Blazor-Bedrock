@page "/chatgpt/prompts/create"
@page "/chatgpt/prompts/edit/{Id:int}"
@using Blazor_Bedrock.Services.ChatGpt
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.FeatureFlag
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Forms
@inject IPromptService PromptService
@inject ITenantService TenantService
@inject IFeatureFlagService FeatureFlagService
@inject NavigationManager Navigation
@inject INotificationService NotificationService
@rendermode InteractiveServer

<PageTitle>@(_isEdit ? "Edit Prompt" : "Create Prompt")</PageTitle>

<div class="container mt-4" style="max-width: 800px;">
    <h4 class="mb-4">@(_isEdit ? "Edit Prompt" : "Create New Prompt")</h4>
    
    <div class="card shadow">
        <div class="card-body p-4">
            @if (_prompt != null || !_isEdit)
            {
                <EditForm Model="@_promptModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="name" @bind="_promptModel.Name" required />
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" @bind="_promptModel.Description"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="promptType" class="form-label">Prompt Type *</label>
                        <InputSelect class="form-select" id="promptType" @bind-Value="_promptModel.PromptType">
                            <option value="@PromptType.Chat">Chat - General chat prompts</option>
                            <option value="@PromptType.Chart">Chart - Chart data analysis prompts</option>
                        </InputSelect>
                        <div class="form-text">Select where this prompt will be used. Chat prompts appear in the chat interface, Chart prompts appear when creating charts.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="promptText" class="form-label">Prompt Text *</label>
                        <textarea class="form-control" id="promptText" rows="12" @bind="_promptModel.PromptText" required></textarea>
                        <div class="form-text">Enter your prompt template text. This defines how ChatGPT should behave and respond.</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isSystemPrompt" @bind="_promptModel.IsSystemPrompt" />
                        <label class="form-check-label" for="isSystemPrompt">Use as System Prompt</label>
                    </div>
                    <small class="text-muted d-block mb-4">
                        If checked, this prompt will be used as the system prompt in chat conversations (only applies to Chat type prompts)
                    </small>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-secondary" @onclick="NavigateBack">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
            else
            {
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int? Id { get; set; }
    
    private bool _isEdit => Id.HasValue;
    private ChatGptPrompt? _prompt;
    private PromptModel _promptModel = new();
    private bool _isLoading = false;
    private int? _currentTenantId;

    private class PromptModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public PromptType PromptType { get; set; } = PromptType.Chat;
        public string PromptText { get; set; } = string.Empty;
        public bool IsSystemPrompt { get; set; } = false;
    }

    private bool _featureDisabled = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if ChatGpt feature is enabled
        var isEnabled = await FeatureFlagService.IsEnabledAsync("ChatGpt_Enabled");
        if (!isEnabled)
        {
            _featureDisabled = true;
            return;
        }

        _currentTenantId = TenantService.GetCurrentTenantId();

        if (_isEdit && Id.HasValue)
        {
            _prompt = await PromptService.GetPromptByIdAsync(Id.Value, _currentTenantId);
            if (_prompt != null)
            {
                _promptModel = new PromptModel
                {
                    Name = _prompt.Name,
                    Description = _prompt.Description,
                    PromptType = _prompt.PromptType,
                    PromptText = _prompt.PromptText,
                    IsSystemPrompt = _prompt.IsSystemPrompt
                };
            }
            else
            {
                await NotificationService.ShowErrorAsync("Prompt not found");
                Navigation.NavigateTo("/chatgpt/prompts");
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _featureDisabled)
        {
            await Task.Delay(100);
            Navigation.NavigateTo("/?error=" + Uri.EscapeDataString("ChatGPT feature has been disabled"));
            return;
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_promptModel.Name) || string.IsNullOrWhiteSpace(_promptModel.PromptText))
        {
            await NotificationService.ShowWarningAsync("Name and Prompt Text are required.");
            return;
        }

        _isLoading = true;
        try
        {
            if (_isEdit && _prompt != null && Id.HasValue)
            {
                var promptToUpdate = new ChatGptPrompt
                {
                    Id = _prompt.Id,
                    Name = _promptModel.Name,
                    Description = _promptModel.Description,
                    PromptType = _promptModel.PromptType,
                    PromptText = _promptModel.PromptText,
                    IsSystemPrompt = _promptModel.IsSystemPrompt
                };

                var result = await PromptService.UpdatePromptAsync(Id.Value, promptToUpdate, _currentTenantId);
                if (result)
                {
                    await NotificationService.ShowSuccessAsync("Prompt updated successfully");
                    Navigation.NavigateTo("/chatgpt/prompts");
                }
                else
                {
                    await NotificationService.ShowErrorAsync("Error updating prompt. Prompt not found.");
                }
            }
            else
            {
                var newPrompt = new ChatGptPrompt
                {
                    Name = _promptModel.Name,
                    Description = _promptModel.Description,
                    PromptType = _promptModel.PromptType,
                    PromptText = _promptModel.PromptText,
                    IsSystemPrompt = _promptModel.IsSystemPrompt
                };

                await PromptService.CreatePromptAsync(newPrompt, _currentTenantId);
                await NotificationService.ShowSuccessAsync("Prompt created successfully");
                Navigation.NavigateTo("/chatgpt/prompts");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"Error saving prompt: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/chatgpt/prompts");
    }
}
