@page "/chatgpt/prompts"
@using Blazor_Bedrock.Services.ChatGpt
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.FeatureFlag
@using Blazor_Bedrock.Data.Models
@using Blazor_Bedrock.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject IPromptService PromptService
@inject ITenantService TenantService
@inject IFeatureFlagService FeatureFlagService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject IDatabaseSyncService DbSync
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>ChatGPT Prompt Management</PageTitle>

<div class="container-fluid mt-4">
    <h4 class="mb-4">Prompt Templates</h4>
    
    <div class="card shadow mb-4">
        <div class="card-body p-4">
            <h6 class="mb-2">
                <i class="bi bi-info-circle me-2"></i>
                About Prompt Templates
            </h6>
            <p class="mb-2">
                <strong>Prompt Templates work like CustomGPT instructions.</strong> They define how ChatGPT should behave and respond to your questions.
            </p>
            <p class="mb-0"><strong>Key Points:</strong></p>
            <ul>
                <li>Use templates to set response style (e.g., "always answer in point form")</li>
                <li>Define analysis approach (e.g., "provide correlation percentages")</li>
                <li>Set tone and format (e.g., "use technical language", "include citations")</li>
                <li>System prompts are used automatically in chat conversations</li>
            </ul>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6>Prompts</h6>
                <button class="btn btn-primary" @onclick="NavigateToCreate">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create New Prompt
                </button>
            </div>

            @if (prompts == null)
            {
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (!prompts.Any())
            {
                <div class="alert alert-info">
                    <strong>No prompts created yet.</strong> Click "Create New Prompt" to get started.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>System Prompt</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var prompt in prompts)
                            {
                                <tr>
                                    <td><strong>@prompt.Name</strong></td>
                                    <td>@(prompt.Description ?? "-")</td>
                                    <td>
                                        @if (prompt.PromptType == PromptType.Chart)
                                        {
                                            <span class="badge bg-info">Chart</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-primary">Chat</span>
                                        }
                                    </td>
                                    <td>
                                        @if (prompt.IsSystemPrompt)
                                        {
                                            <span class="badge bg-success">Yes</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">No</span>
                                        }
                                    </td>
                                    <td>@prompt.CreatedAt.ToString("yyyy-MM-dd")</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => NavigateToEdit(prompt.Id)">
                                                <i class="bi bi-pencil me-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePrompt(prompt.Id)">
                                                <i class="bi bi-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<ChatGptPrompt>? prompts;
    private int? currentTenantId;

    private bool _featureDisabled = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if ChatGpt feature is enabled
        var isEnabled = await FeatureFlagService.IsEnabledAsync("ChatGpt_Enabled");
        if (!isEnabled)
        {
            _featureDisabled = true;
            return;
        }

        currentTenantId = TenantService.GetCurrentTenantId();
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _featureDisabled)
        {
            await Task.Delay(100);
            Navigation.NavigateTo("/?error=" + Uri.EscapeDataString("ChatGPT feature has been disabled"));
            return;
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task LoadData()
    {
        // Load all prompts (both Chat and Chart types) for management page
        prompts = await PromptService.GetAllPromptsAsync(currentTenantId);
        StateHasChanged();
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/chatgpt/prompts/create");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/chatgpt/prompts/edit/{id}");
    }

    private async Task DeletePrompt(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this prompt?");
        if (!confirmed)
            return;

        try
        {
            var result = await PromptService.DeletePromptAsync(id, currentTenantId);
            if (result)
            {
                await NotificationService.ShowSuccessAsync("Prompt deleted successfully");
                await LoadData();
            }
            else
            {
                await NotificationService.ShowErrorAsync("Error deleting prompt. Prompt not found.");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"Error deleting prompt: {ex.Message}");
        }
    }
}
