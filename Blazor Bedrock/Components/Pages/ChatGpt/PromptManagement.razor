@page "/chatgpt/prompts"
@using Blazor_Bedrock.Services.ChatGpt
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Data.Models
@using Blazor_Bedrock.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MudBlazor
@inject IPromptService PromptService
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDatabaseSyncService DbSync
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>ChatGPT Prompt Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Prompt Templates</MudText>
    
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
            About Prompt Templates
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-2">
            <strong>Prompt Templates work like CustomGPT instructions.</strong> They define how ChatGPT should behave and respond to your questions.
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-0">
            <strong>Key Points:</strong>
        </MudText>
        <ul>
            <li>Use templates to set response style (e.g., "always answer in point form")</li>
            <li>Define analysis approach (e.g., "provide correlation percentages")</li>
            <li>Set tone and format (e.g., "use technical language", "include citations")</li>
            <li>System prompts are used automatically in chat conversations</li>
        </ul>
    </MudPaper>

    <MudPaper Elevation="2" Class="pa-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <MudText Typo="Typo.h6">Prompts</MudText>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="NavigateToCreate">
                Create New Prompt
            </MudButton>
        </div>

        @if (prompts == null)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (!prompts.Any())
        {
            <MudAlert Severity="Severity.Info">
                <strong>No prompts created yet.</strong> Click "Create New Prompt" to get started.
            </MudAlert>
        }
        else
        {
            <MudTable Items="prompts" Hover="true" Dense="false" Striped="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>System Prompt</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">
                        <strong>@context.Name</strong>
                    </MudTd>
                    <MudTd DataLabel="Description">
                        @(context.Description ?? "-")
                    </MudTd>
                    <MudTd DataLabel="System Prompt">
                        @if (context.IsSystemPrompt)
                        {
                            <MudChip Size="Size.Small" Color="Color.Success" T="string">Yes</MudChip>
                        }
                        else
                        {
                            <MudChip Size="Size.Small" Color="Color.Default" T="string">No</MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Created">
                        @context.CreatedAt.ToString("yyyy-MM-dd")
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudButtonGroup Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">
                            <MudButton StartIcon="@Icons.Material.Filled.Edit" OnClick="() => NavigateToEdit(context.Id)">Edit</MudButton>
                            <MudButton StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeletePrompt(context.Id)">Delete</MudButton>
                        </MudButtonGroup>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<ChatGptPrompt>? prompts;
    private int? currentTenantId;

    protected override async Task OnInitializedAsync()
    {
        currentTenantId = TenantService.GetCurrentTenantId();
        await LoadData();
    }

    private async Task LoadData()
    {
        prompts = await PromptService.GetAllPromptsAsync(currentTenantId);
        StateHasChanged();
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/chatgpt/prompts/create");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/chatgpt/prompts/edit/{id}");
    }

    private async Task DeletePrompt(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this prompt?");
        if (!confirmed)
            return;

        try
        {
            var result = await PromptService.DeletePromptAsync(id, currentTenantId);
            if (result)
            {
                Snackbar.Add("Prompt deleted successfully", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add("Error deleting prompt. Prompt not found.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting prompt: {ex.Message}", Severity.Error);
        }
    }
}

