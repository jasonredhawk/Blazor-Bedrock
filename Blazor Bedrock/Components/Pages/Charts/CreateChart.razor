@page "/charts/create"
@using Blazor_Bedrock.Services.Chart
@using Blazor_Bedrock.Services.Document
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.FeatureFlag
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject IChartService ChartService
@inject IDocumentService DocumentService
@inject ITenantService TenantService
@inject IFeatureFlagService FeatureFlagService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject INotificationService NotificationService
@rendermode InteractiveServer

<PageTitle>Create Chart - Blazor Bedrock</PageTitle>

<FeatureGate FeatureName="Charts_Enabled">
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Create Chart from Data</h2>
            <a href="/charts" class="btn btn-secondary">Back to Charts</a>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => { errorMessage = null; StateHasChanged(); }" aria-label="Close"></button>
            </div>
        }

        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            <EditForm Model="@_request" OnValidSubmit="CreateChartAsync">
                <DataAnnotationsValidator />

                <div class="row">
                    <!-- Left Column: Configuration -->
                    <div class="col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Chart Configuration</h5>
                            </div>
                            <div class="card-body">
                                <!-- Document Selection -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Select Document *</label>
                                    @if (_availableDocuments == null)
                                    {
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            <span class="ms-2">Loading documents...</span>
                                        </div>
                                    }
                                    else if (!_availableDocuments.Any())
                                    {
                                        <div class="alert alert-warning">
                                            No Excel or CSV documents found. <a href="/documents/upload">Upload a document</a> first.
                                        </div>
                                    }
                                    else
                                    {
                                        <InputSelect class="form-select" @bind-Value="_request.DocumentId" @bind-Value:after="OnDocumentSelectedAsync">
                                            <option value="0">-- Select a document --</option>
                                            @foreach (var doc in _availableDocuments)
                                            {
                                                <option value="@doc.Id">@(doc.Title ?? doc.FileName)</option>
                                            }
                                        </InputSelect>
                                    }
                                </div>

                                @if (_request.DocumentId > 0 && _sheetDataList != null && _sheetDataList.Any())
                                {
                                    <!-- Sheet Selection -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Select Sheet</label>
                                        <InputSelect class="form-select" @bind-Value="_request.SheetName" @bind-Value:after="OnSheetSelectionChanged">
                                            <option value="">-- Use first sheet --</option>
                                            @foreach (var sheet in _sheetDataList)
                                            {
                                                <option value="@sheet.SheetName">@sheet.SheetName</option>
                                            }
                                        </InputSelect>
                                    </div>
                                }

                                <!-- Chart Title -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chart Title *</label>
                                    <InputText class="form-control" @bind-Value="_request.Configuration.Title" />
                                    <ValidationMessage For="@(() => _request.Configuration.Title)" />
                                </div>

                                <!-- Chart Type -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chart Type *</label>
                                    <InputSelect class="form-select" @bind-Value="_request.Configuration.ChartType">
                                        <option value="@ChartType.LineMarkers">Line with Markers</option>
                                        <option value="@ChartType.Line">Line</option>
                                        <option value="@ChartType.ColumnClustered">Column (Clustered)</option>
                                        <option value="@ChartType.ColumnStacked">Column (Stacked)</option>
                                        <option value="@ChartType.BarClustered">Bar (Clustered)</option>
                                        <option value="@ChartType.BarStacked">Bar (Stacked)</option>
                                        <option value="@ChartType.Pie">Pie</option>
                                        <option value="@ChartType.Scatter">Scatter</option>
                                        <option value="@ChartType.Area">Area</option>
                                        <option value="@ChartType.AreaStacked">Area (Stacked)</option>
                                    </InputSelect>
                                </div>

                                @if (_headers != null && _headers.Any())
                                {
                                    <!-- X-Axis Column -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">X-Axis Column *</label>
                                        <select class="form-select" @bind="_selectedXAxisColumn">
                                            <option value="">-- Select column --</option>
                                            @foreach (var header in _headers)
                                            {
                                                <option value="@header">@header</option>
                                            }
                                        </select>
                                    </div>

                                    <!-- Y-Axis Columns -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Y-Axis Columns *</label>
                                        <small class="text-muted d-block mb-2">Select one or more columns for the Y-axis</small>
                                        @foreach (var header in _headers)
                                        {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="yaxis-@header" 
                                                       checked="@(_selectedYAxisColumns.Contains(header))"
                                                       @onchange="@((ChangeEventArgs e) => ToggleYAxisColumn(header, e.Value?.ToString() == "True"))" />
                                                <label class="form-check-label" for="yaxis-@header">
                                                    @header
                                                </label>
                                            </div>
                                        }
                                    </div>

                                    <!-- Data Start Row -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Data Start Row</label>
                                        <small class="text-muted d-block mb-2">Row number where data starts (1-based, leave empty to start from row 2)</small>
                                        <InputNumber class="form-control" @bind-Value="_request.Configuration.DataStartRow" />
                                    </div>
                                }

                                <!-- Axis Titles -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">X-Axis Title</label>
                                    <InputText class="form-control" @bind-Value="_request.Configuration.XAxisTitle" placeholder="Leave empty for default" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Y-Axis Title</label>
                                    <InputText class="form-control" @bind-Value="_request.Configuration.YAxisTitle" placeholder="Leave empty for default" />
                                </div>

                                <!-- Legend Options -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="_request.Configuration.ShowLegend" />
                                        <label class="form-check-label fw-bold">Show Legend</label>
                                    </div>
                                </div>

                                @if (_request.Configuration.ShowLegend)
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Legend Position</label>
                                        <InputSelect class="form-select" @bind-Value="_request.Configuration.LegendPosition">
                                            <option value="Right">Right</option>
                                            <option value="Left">Left</option>
                                            <option value="Top">Top</option>
                                            <option value="Bottom">Bottom</option>
                                        </InputSelect>
                                    </div>
                                }

                                <!-- Data Analysis -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="_request.Configuration.IncludeDataAnalysis" />
                                        <label class="form-check-label fw-bold">Include Data Analysis</label>
                                        <small class="text-muted d-block">Generate AI-powered analysis of the data (requires ChatGPT)</small>
                                    </div>
                                </div>

                                <hr class="my-4" />

                                <!-- Advanced: Data Filtering -->
                                <h5 class="mb-3">Data Filtering (Optional)</h5>
                                <p class="text-muted small mb-3">Filter your data by selecting specific values from columns (e.g., specific stations or concentrations)</p>

                                @if (_headers != null && _headers.Any())
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Add Filter Column</label>
                                        <div class="input-group">
                                            <select class="form-select" @bind="_selectedFilterColumn">
                                                <option value="">-- Select column to filter --</option>
                                                @foreach (var header in _headers)
                                                {
                                                    @if (!_request.Filters.Any(f => f.ColumnName.Equals(header, StringComparison.OrdinalIgnoreCase)))
                                                    {
                                                        <option value="@header">@header</option>
                                                    }
                                                }
                                            </select>
                                            <button type="button" class="btn btn-outline-primary" @onclick="AddFilter" disabled="@string.IsNullOrEmpty(_selectedFilterColumn)">
                                                <i class="bi bi-plus-circle me-1"></i>Add Filter
                                            </button>
                                        </div>
                                    </div>

                                    @foreach (var filter in _request.Filters)
                                    {
                                        var searchTerm = _filterSearchTerms.ContainsKey(filter.ColumnName) ? _filterSearchTerms[filter.ColumnName] : string.Empty;
                                        var visibleValues = GetFilteredValues(filter.ColumnName, searchTerm);
                                        var visibleSelectedCount = visibleValues.Count(v => filter.SelectedValues.Contains(v, StringComparer.OrdinalIgnoreCase));
                                        var allVisibleSelected = visibleValues.Any() && visibleValues.All(v => filter.SelectedValues.Contains(v, StringComparer.OrdinalIgnoreCase));
                                        
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0">Filter: @filter.ColumnName</h6>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => RemoveFilter(filter)">
                                                        <i class="bi bi-x-circle"></i> Remove
                                                    </button>
                                                </div>
                                                <div class="small text-muted mb-2">Select values to include (leave empty to include all):</div>
                                                
                                                <!-- Search bar for filtering visible options -->
                                                <div class="mb-2">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               placeholder="Search to filter options..." 
                                                               value="@searchTerm"
                                                               @oninput="@((ChangeEventArgs e) => UpdateFilterSearch(filter.ColumnName, e.Value?.ToString() ?? string.Empty))" />
                                                        @if (!string.IsNullOrEmpty(searchTerm))
                                                        {
                                                            <button type="button" class="btn btn-outline-secondary" @onclick="() => ClearFilterSearch(filter.ColumnName)">
                                                                <i class="bi bi-x"></i>
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                                
                                                <!-- Select All / Deselect All buttons -->
                                                @if (visibleValues.Any())
                                                {
                                                    <div class="mb-2 d-flex gap-2">
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-primary" 
                                                                @onclick="() => SelectAllVisible(filter, visibleValues)"
                                                                disabled="@allVisibleSelected">
                                                            <i class="bi bi-check-square me-1"></i>Select All (@visibleValues.Count visible)
                                                        </button>
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-secondary" 
                                                                @onclick="() => DeselectAllVisible(filter, visibleValues)"
                                                                disabled="@(visibleSelectedCount == 0)">
                                                            <i class="bi bi-square me-1"></i>Deselect All Visible
                                                        </button>
                                                    </div>
                                                }
                                                
                                                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.5rem;">
                                                    @if (_filterValues.ContainsKey(filter.ColumnName))
                                                    {
                                                        @if (visibleValues.Any())
                                                        {
                                                            @foreach (var value in visibleValues)
                                                            {
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" 
                                                                           id="filter-@filter.ColumnName-@value" 
                                                                           checked="@filter.SelectedValues.Contains(value, StringComparer.OrdinalIgnoreCase)"
                                                                           @onchange="@((ChangeEventArgs e) => ToggleFilterValue(filter, value, e.Value?.ToString() == "True"))" />
                                                                    <label class="form-check-label" for="filter-@filter.ColumnName-@value">
                                                                        @value
                                                                    </label>
                                                                </div>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <div class="text-muted">
                                                                @if (!string.IsNullOrEmpty(searchTerm))
                                                                {
                                                                    <span>No values match "@searchTerm"</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>No values available</span>
                                                                }
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <div class="text-muted">Loading values...</div>
                                                    }
                                                </div>
                                                @if (filter.SelectedValues.Any())
                                                {
                                                    <div class="mt-2">
                                                        <small class="text-success">
                                                            <i class="bi bi-check-circle me-1"></i>@filter.SelectedValues.Count value(s) selected
                                                            @if (!string.IsNullOrEmpty(searchTerm) && visibleSelectedCount < filter.SelectedValues.Count)
                                                            {
                                                                <span class="text-muted">(@visibleSelectedCount visible)</span>
                                                            }
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                }

                                <hr class="my-4" />

                                <!-- Advanced: Multiple Charts -->
                                <h5 class="mb-3">Multiple Charts (Optional)</h5>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="_request.CreateMultipleCharts" />
                                        <label class="form-check-label fw-bold">Create Multiple Charts</label>
                                        <small class="text-muted d-block">Create separate worksheets, each with its own chart</small>
                                    </div>
                                </div>

                                @if (_request.CreateMultipleCharts)
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Group By Column</label>
                                        <small class="text-muted d-block mb-2">Each unique value in this column will get its own worksheet and chart</small>
                                        @if (_headers != null && _headers.Any())
                                        {
                                            <InputSelect class="form-select" @bind-Value="_request.GroupByColumn">
                                                <option value="">-- Select column to group by --</option>
                                                @foreach (var header in _headers)
                                                {
                                                    <option value="@header">@header</option>
                                                }
                                            </InputSelect>
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(_request.GroupByColumn))
                                    {
                                        var groupCount = GetUniqueGroupCount(_request.GroupByColumn);
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Preview:</strong> <strong>@groupCount</strong> chart(s) will be created, one for each unique value in "@_request.GroupByColumn"
                                            @if (_request.Filters.Any(f => f.IsActive && f.ColumnName.Equals(_request.GroupByColumn, StringComparison.OrdinalIgnoreCase)))
                                            {
                                                <span class="text-muted d-block mt-1">(Only filtered values will be used)</span>
                                            }
                                        </div>
                                    }
                                }

                                <!-- Submit Button -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg" disabled="@_isCreatingChart">
                                        @if (_isCreatingChart)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        }
                                        Create Chart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Data Preview -->
                    <div class="col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Data Preview</h5>
                            </div>
                            <div class="card-body">
                                @if (_request.DocumentId == 0)
                                {
                                    <div class="text-center text-muted py-5">
                                        <i class="bi bi-file-earmark-spreadsheet display-1"></i>
                                        <p class="mt-3">Select a document to preview its data</p>
                                    </div>
                                }
                                else if (_sheetDataList == null || !_sheetDataList.Any())
                                {
                                    <div class="text-center text-muted py-5">
                                        <div class="spinner-border" role="status"></div>
                                        <p class="mt-3">Loading data preview...</p>
                                    </div>
                                }
                                else if (_currentSheetData == null || !_currentSheetData.Rows.Any())
                                {
                                    <div class="alert alert-warning">
                                        No data found in the selected sheet.
                                    </div>
                                }
                                else
                                {
                                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                        <table class="table table-sm table-striped table-bordered">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    @foreach (var header in _headers)
                                                    {
                                                        <th>@header</th>
                                                    }
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in _previewRows)
                                                {
                                                    <tr>
                                                        @foreach (var cell in row)
                                                        {
                                                            <td>@cell</td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <small class="text-muted">
                                        @{
                                            var totalFilteredRows = ApplyFiltersToAllRows().Count;
                                            var totalAllRows = _allRowsData != null ? _allRowsData.Rows.Count - 1 : 0; // Subtract header
                                        }
                                        Showing first 50 rows of filtered data. 
                                        @if (_request.Filters.Any(f => f.IsActive))
                                        {
                                            <text>Filtered: @totalFilteredRows rows (from @totalAllRows total rows)</text>
                                        }
                                        else
                                        {
                                            <text>Total rows: @totalAllRows</text>
                                        }
                                    </small>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</FeatureGate>

@code {
    private ChartCreationRequest _request = new();
    private List<Document>? _availableDocuments;
    private List<Infrastructure.ExternalApis.SheetData>? _sheetDataList;
    private Infrastructure.ExternalApis.SheetData? _currentSheetData;
    private List<string> _headers = new();
    private List<List<string>> _previewRows = new();
    private Infrastructure.ExternalApis.SheetData? _allRowsData; // Store ALL rows for filtering
    private string _selectedXAxisColumn = string.Empty;
    private List<string> _selectedYAxisColumns = new();
    private string _selectedFilterColumn = string.Empty;
    private Dictionary<string, List<string>> _filterValues = new(); // Column name -> unique values
    private Dictionary<string, string> _filterSearchTerms = new(); // Column name -> search term for filtering visible options
    private string? errorMessage;
    private bool _isLoading = true;
    private bool _isCreatingChart = false;
    private string? userId;
    private int? tenantId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        tenantId = TenantService.GetCurrentTenantId();

        if (string.IsNullOrEmpty(userId) || tenantId == null)
        {
            errorMessage = "Unable to identify user or organization.";
            _isLoading = false;
            return;
        }

        // Check if Charts feature is enabled
        var isEnabled = await FeatureFlagService.IsEnabledAsync("Charts_Enabled");
        if (!isEnabled)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadDocuments();
        _isLoading = false;
    }

    private async Task LoadDocuments()
    {
        if (string.IsNullOrEmpty(userId) || tenantId == null)
            return;

        try
        {
            var allDocuments = await DocumentService.GetAllDocumentsAsync(userId, tenantId.Value);
            
            // Filter for Excel and CSV files only
            _availableDocuments = allDocuments
                .Where(d => 
                    d.ContentType.Contains("spreadsheet") || 
                    d.ContentType.Contains("excel") ||
                    d.ContentType.Contains("csv") ||
                    d.FileName.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase) ||
                    d.FileName.EndsWith(".xls", StringComparison.OrdinalIgnoreCase) ||
                    d.FileName.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
                .OrderByDescending(d => d.UploadedAt)
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading documents: {ex.Message}";
        }
    }

    private async Task OnDocumentSelectedAsync()
    {
        if (_request.DocumentId == 0)
        {
            _sheetDataList = null;
            _currentSheetData = null;
            _allRowsData = null;
            _headers.Clear();
            _previewRows.Clear();
            _selectedXAxisColumn = string.Empty;
            _selectedYAxisColumns.Clear();
            _request.Filters.Clear();
            _filterValues.Clear();
            _filterSearchTerms.Clear();
            return;
        }

        try
        {
            _isLoading = true;
            StateHasChanged();
            
            // Get ALL rows for filtering and chart creation (maxRows: 0 = all rows)
            _sheetDataList = await DocumentService.GetStructuredDataAsync(_request.DocumentId, userId!, tenantId!.Value, maxRows: 0);
            
            if (_sheetDataList != null && _sheetDataList.Any())
            {
                // Reset sheet name to first sheet
                _request.SheetName = string.Empty;
                
                // Use first sheet - store ALL rows
                _currentSheetData = _sheetDataList.First();
                _allRowsData = _currentSheetData; // Keep a copy of all rows

                UpdatePreview();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading document data: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSheetSelectionChanged()
    {
        if (_sheetDataList == null || !_sheetDataList.Any())
            return;

        // Update current sheet data based on selection - get ALL rows
        _currentSheetData = string.IsNullOrEmpty(_request.SheetName)
            ? _sheetDataList.First()
            : _sheetDataList.FirstOrDefault(s => s.SheetName.Equals(_request.SheetName, StringComparison.OrdinalIgnoreCase)) ?? _sheetDataList.First();
        
        _allRowsData = _currentSheetData; // Keep a copy of all rows

        UpdatePreview();
        
        // Clear axis selections and filters when sheet changes
        _selectedXAxisColumn = string.Empty;
        _selectedYAxisColumns.Clear();
        _request.Filters.Clear();
        _filterValues.Clear();
        _filterSearchTerms.Clear();
    }

    private void UpdatePreview()
    {
        if (_allRowsData == null || !_allRowsData.Rows.Any())
        {
            _headers.Clear();
            _previewRows.Clear();
            // Don't clear _filterValues here - keep them for the dropdowns
            return;
        }

        // First row is headers
        _headers = _allRowsData.Rows[0];

        // Apply filters to get filtered data
        var filteredRows = ApplyFiltersToAllRows();

        // Preview rows (limit to 50 for performance) - show filtered results
        _previewRows = filteredRows
            .Take(50)
            .ToList();

        // Extract unique values for each column from ALL rows (for filtering dropdowns)
        // Always reload from ALL rows to ensure we have complete lists, regardless of any filters
        // Remove the 500 limit to show all values - the search and virtual scrolling will handle performance
        foreach (var header in _headers)
        {
            var columnIndex = _headers.IndexOf(header);
            var uniqueValues = _allRowsData.Rows
                .Skip(1) // Skip header
                .Where(row => columnIndex < row.Count && !string.IsNullOrWhiteSpace(row[columnIndex]))
                .Select(row => row[columnIndex].Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(v => v)
                .ToList(); // Removed .Take(500) to show all values
            
            _filterValues[header] = uniqueValues;
        }

        // Update chart configuration defaults
        if (_headers.Any() && string.IsNullOrEmpty(_request.Configuration.Title))
        {
            var doc = _availableDocuments?.FirstOrDefault(d => d.Id == _request.DocumentId);
            _request.Configuration.Title = $"Chart from {doc?.Title ?? doc?.FileName ?? "Data"}";
        }
    }

    private void EnsureFilterValuesLoaded()
    {
        if (_allRowsData == null || !_allRowsData.Rows.Any() || _headers == null || !_headers.Any())
            return;

        // Always reload filter values from ALL rows to ensure complete lists
        // This ensures that when a new filter is added, it shows all possible values from the entire dataset
        // Removed the 500 limit to show all values
        foreach (var header in _headers)
        {
            var columnIndex = _headers.IndexOf(header);
            var uniqueValues = _allRowsData.Rows
                .Skip(1) // Skip header
                .Where(row => columnIndex < row.Count && !string.IsNullOrWhiteSpace(row[columnIndex]))
                .Select(row => row[columnIndex].Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(v => v)
                .ToList(); // Removed .Take(500) to show all values
            
            _filterValues[header] = uniqueValues;
        }
    }

    private List<string> GetFilteredValues(string columnName, string searchTerm)
    {
        if (!_filterValues.ContainsKey(columnName))
            return new List<string>();

        var allValues = _filterValues[columnName];
        
        if (string.IsNullOrWhiteSpace(searchTerm))
            return allValues;

        var searchLower = searchTerm.ToLowerInvariant();
        return allValues
            .Where(v => v.ToLowerInvariant().Contains(searchLower))
            .ToList();
    }

    private void UpdateFilterSearch(string columnName, string searchTerm)
    {
        _filterSearchTerms[columnName] = searchTerm ?? string.Empty;
        StateHasChanged();
    }

    private void ClearFilterSearch(string columnName)
    {
        if (_filterSearchTerms.ContainsKey(columnName))
        {
            _filterSearchTerms.Remove(columnName);
        }
        StateHasChanged();
    }

    private void SelectAllVisible(ChartFilter filter, List<string> visibleValues)
    {
        foreach (var value in visibleValues)
        {
            if (!filter.SelectedValues.Contains(value, StringComparer.OrdinalIgnoreCase))
            {
                filter.SelectedValues.Add(value);
            }
        }
        UpdatePreview();
        StateHasChanged();
    }

    private void DeselectAllVisible(ChartFilter filter, List<string> visibleValues)
    {
        foreach (var value in visibleValues)
        {
            filter.SelectedValues.RemoveAll(v => v.Equals(value, StringComparison.OrdinalIgnoreCase));
        }
        UpdatePreview();
        StateHasChanged();
    }

    private List<List<string>> ApplyFiltersToAllRows()
    {
        if (_allRowsData == null || _allRowsData.Rows.Count <= 1)
            return new List<List<string>>();

        var headers = _allRowsData.Rows[0];
        var activeFilters = _request.Filters.Where(f => f.IsActive && f.SelectedValues.Any()).ToList();

        // If no active filters, return all rows (except header)
        if (!activeFilters.Any())
        {
            return _allRowsData.Rows.Skip(1).ToList();
        }

        var filtered = new List<List<string>>();
        
        // Filter all rows based on active filters
        for (int rowIndex = 1; rowIndex < _allRowsData.Rows.Count; rowIndex++)
        {
            var row = _allRowsData.Rows[rowIndex];
            bool includeRow = true;

            foreach (var filter in activeFilters)
            {
                var columnIndex = headers.IndexOf(filter.ColumnName);
                if (columnIndex >= 0 && columnIndex < row.Count)
                {
                    var cellValue = row[columnIndex]?.Trim() ?? string.Empty;
                    if (!filter.SelectedValues.Contains(cellValue, StringComparer.OrdinalIgnoreCase))
                    {
                        includeRow = false;
                        break;
                    }
                }
            }

            if (includeRow)
            {
                filtered.Add(row);
            }
        }

        return filtered;
    }

    private void AddFilter()
    {
        if (string.IsNullOrEmpty(_selectedFilterColumn))
            return;

        if (!_request.Filters.Any(f => f.ColumnName.Equals(_selectedFilterColumn, StringComparison.OrdinalIgnoreCase)))
        {
            _request.Filters.Add(new ChartFilter
            {
                ColumnName = _selectedFilterColumn,
                SelectedValues = new List<string>()
            });
            _selectedFilterColumn = string.Empty;
            
            // Ensure filter values are loaded for this column
            EnsureFilterValuesLoaded();
            StateHasChanged();
        }
    }

    private void RemoveFilter(ChartFilter filter)
    {
        _request.Filters.Remove(filter);
        // Update preview when filter is removed
        UpdatePreview();
    }

    private void ToggleFilterValue(ChartFilter filter, string value, bool isSelected)
    {
        if (isSelected && !filter.SelectedValues.Contains(value, StringComparer.OrdinalIgnoreCase))
        {
            filter.SelectedValues.Add(value);
        }
        else if (!isSelected)
        {
            filter.SelectedValues.RemoveAll(v => v.Equals(value, StringComparison.OrdinalIgnoreCase));
        }
        
        // Update preview when filter changes (synchronous - no database calls)
        UpdatePreview();
        StateHasChanged();
    }

    private int GetUniqueGroupCount(string columnName)
    {
        if (_allRowsData == null || string.IsNullOrEmpty(columnName))
            return 0;

        var columnIndex = _headers.IndexOf(columnName);
        if (columnIndex < 0)
            return 0;

        // Apply active filters to ALL rows
        var filteredRows = ApplyFiltersToAllRows();

        var uniqueValues = filteredRows
            .Where(row => columnIndex < row.Count && !string.IsNullOrWhiteSpace(row[columnIndex]))
            .Select(row => row[columnIndex].Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .Count();

        return uniqueValues;
    }

    private void ToggleYAxisColumn(string columnName, bool isSelected)
    {
        if (isSelected && !_selectedYAxisColumns.Contains(columnName))
        {
            _selectedYAxisColumns.Add(columnName);
        }
        else if (!isSelected)
        {
            _selectedYAxisColumns.Remove(columnName);
        }
    }

    private async Task CreateChartAsync()
    {
        if (string.IsNullOrEmpty(userId) || tenantId == null)
        {
            errorMessage = "Unable to identify user or organization.";
            return;
        }

        // Validate selections
        if (_request.DocumentId == 0)
        {
            errorMessage = "Please select a document.";
            return;
        }

        if (string.IsNullOrEmpty(_selectedXAxisColumn))
        {
            errorMessage = "Please select an X-axis column.";
            return;
        }

        if (!_selectedYAxisColumns.Any())
        {
            errorMessage = "Please select at least one Y-axis column.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_request.Configuration.Title))
        {
            errorMessage = "Please enter a chart title.";
            return;
        }

        // Update request with selected columns
        _request.Configuration.XAxisColumns = new List<string> { _selectedXAxisColumn };
        _request.Configuration.YAxisColumns = _selectedYAxisColumns.ToList();

        _isCreatingChart = true;
        errorMessage = null;

        try
        {
            var result = await ChartService.CreateChartAsync(_request, userId, tenantId.Value);

            // Download the file
            await JSRuntime.InvokeVoidAsync("downloadFile", result.FileName, Convert.ToBase64String(result.ExcelFileBytes), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            var message = result.ChartsCreated > 1
                ? $"Successfully created {result.ChartsCreated} charts in {result.ChartsCreated} worksheets! The file is downloading."
                : "Chart created successfully! The file is downloading.";
            
            await NotificationService.ShowSuccessAsync(message);

            // Optionally show data analysis (only for single charts)
            if (!string.IsNullOrEmpty(result.DataAnalysis) && result.ChartsCreated == 1)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Data Analysis:\n\n{result.DataAnalysis}");
            }

            // Reset form or navigate
            Navigation.NavigateTo("/charts");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating chart: {ex.Message}";
        }
        finally
        {
            _isCreatingChart = false;
        }
    }
}
