@page "/charts/create"
@using Blazor_Bedrock.Services.Chart
@using Blazor_Bedrock.Services.Document
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.FeatureFlag
@using Blazor_Bedrock.Services.ChatGpt
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject IChartService ChartService
@inject IDocumentService DocumentService
@inject ITenantService TenantService
@inject IFeatureFlagService FeatureFlagService
@inject IPromptService PromptService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject INotificationService NotificationService
@rendermode InteractiveServer

<PageTitle>Create Chart - Blazor Bedrock</PageTitle>

<FeatureGate FeatureName="Charts_Enabled">
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Create Chart from Data</h2>
            <div>
                <a href="/charts" class="btn btn-secondary me-2">Back to Charts</a>
            </div>
        </div>

        <!-- Load Saved Chart Section -->
        <div class="card shadow mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-folder2-open me-2"></i>Load Saved Chart (Optional)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Select Saved Chart</label>
                        @if (_savedCharts == null)
                        {
                            <div class="text-muted">Loading saved charts...</div>
                        }
                        else if (!_savedCharts.Any())
                        {
                            <div class="text-muted">No saved charts yet. Create and save a chart to load it later.</div>
                        }
                        else
                        {
                            <InputSelect class="form-select" @bind-Value="_selectedSavedChartId" @bind-Value:after="LoadSavedChartAsync">
                                <option value="0">-- Select a saved chart to load --</option>
                                @foreach (var chart in _savedCharts)
                                {
                                    <option value="@chart.Id">@chart.Name @(!string.IsNullOrEmpty(chart.Description) ? $" - {chart.Description}" : "")</option>
                                }
                            </InputSelect>
                        }
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        @if (_currentSavedChartId.HasValue && _currentSavedChartId.Value > 0 && _savedCharts != null)
                        {
                            <button type="button" class="btn btn-danger w-100" @onclick="DeleteCurrentSavedChartAsync">
                                <i class="bi bi-trash me-2"></i>Delete Saved Chart
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => { errorMessage = null; StateHasChanged(); }" aria-label="Close"></button>
            </div>
        }

        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            <EditForm Model="@_request" OnValidSubmit="CreateChartAsync">
                <DataAnnotationsValidator />

                <div class="row">
                    <!-- Left Column: Configuration -->
                    <div class="col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Chart Configuration</h5>
                            </div>
                            <div class="card-body">
                                <!-- Document Selection -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Select Document *</label>
                                    @if (_availableDocuments == null)
                                    {
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            <span class="ms-2">Loading documents...</span>
                                        </div>
                                    }
                                    else if (!_availableDocuments.Any())
                                    {
                                        <div class="alert alert-warning">
                                            No Excel or CSV documents found. <a href="/documents/upload">Upload a document</a> first.
                                        </div>
                                    }
                                    else
                                    {
                                        <InputSelect class="form-select" @bind-Value="_request.DocumentId" @bind-Value:after="OnDocumentSelectedAsync">
                                            <option value="0">-- Select a document --</option>
                                            @foreach (var doc in _availableDocuments)
                                            {
                                                <option value="@doc.Id">@(doc.Title ?? doc.FileName)</option>
                                            }
                                        </InputSelect>
                                    }
                                </div>

                                @if (_request.DocumentId > 0 && _sheetDataList != null && _sheetDataList.Any())
                                {
                                    <!-- Sheet Selection -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Select Sheet</label>
                                        <InputSelect class="form-select" @bind-Value="_request.SheetName" @bind-Value:after="OnSheetSelectionChanged">
                                            <option value="">-- Use first sheet --</option>
                                            @foreach (var sheet in _sheetDataList)
                                            {
                                                <option value="@sheet.SheetName">@sheet.SheetName</option>
                                            }
                                        </InputSelect>
                                    </div>
                                }

                                <!-- Chart Title -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chart Title *</label>
                                    <InputText class="form-control" @bind-Value="_request.Configuration.Title" />
                                    <ValidationMessage For="@(() => _request.Configuration.Title)" />
                                </div>

                                <!-- Chart Type -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chart Type *</label>
                                    @if (!string.IsNullOrEmpty(_selectedVariableColumn))
                                    {
                                        <div class="alert alert-success mb-2">
                                            <i class="bi bi-lightbulb me-2"></i>
                                            <strong>Multi-Variable Chart:</strong> With multiple variables selected, consider:
                                            <ul class="mb-0 mt-2 small">
                                                <li><strong>Stacked types</strong> (Column Stacked, Bar Stacked, Area Stacked) - Stack variables on top of each other</li>
                                                <li><strong>Clustered types</strong> (Column Clustered, Bar Clustered) - Show variables side-by-side</li>
                                                <li><strong>Line types</strong> (Line, Line with Markers) - Show variables as separate lines</li>
                                            </ul>
                                        </div>
                                    }
                                    <InputSelect class="form-select" @bind-Value="_request.Configuration.ChartType">
                                        <optgroup label="Line Charts (Good for multiple variables)">
                                            <option value="@ChartType.LineMarkers">Line with Markers</option>
                                            <option value="@ChartType.Line">Line</option>
                                        </optgroup>
                                        <optgroup label="Column Charts">
                                            <option value="@ChartType.ColumnClustered">Column (Clustered) - Side-by-side</option>
                                            <option value="@ChartType.ColumnStacked">Column (Stacked) - Stacked on top</option>
                                        </optgroup>
                                        <optgroup label="Bar Charts">
                                            <option value="@ChartType.BarClustered">Bar (Clustered) - Side-by-side</option>
                                            <option value="@ChartType.BarStacked">Bar (Stacked) - Stacked</option>
                                        </optgroup>
                                        <optgroup label="Area Charts">
                                            <option value="@ChartType.Area">Area</option>
                                            <option value="@ChartType.AreaStacked">Area (Stacked) - Stacked</option>
                                        </optgroup>
                                        <optgroup label="Other">
                                            <option value="@ChartType.Pie">Pie (Single variable only)</option>
                                            <option value="@ChartType.Scatter">Scatter</option>
                                        </optgroup>
                                    </InputSelect>
                                    <small class="text-muted d-block mt-1">
                                        @if (!string.IsNullOrEmpty(_selectedVariableColumn))
                                        {
                                            <text>ðŸ’¡ <strong>Tip:</strong> Stacked and clustered types work best with multiple variables. Line charts show each variable as a separate line.</text>
                                        }
                                        else
                                        {
                                            <text>Select X-axis, Y-axis, and Variable column above to create your chart.</text>
                                        }
                                    </small>
                                </div>

                                @if (_headers != null && _headers.Any())
                                {
                                    <!-- X-Axis Column -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Step 1: X-Axis Column (Date) *</label>
                                        <small class="text-muted d-block mb-2">Select the column containing dates or time values</small>
                                        <select class="form-select" @bind="_selectedXAxisColumn" @bind:after="UpdatePreview">
                                            <option value="">-- Select date column --</option>
                                            @foreach (var header in _headers)
                                            {
                                                <option value="@header">@header</option>
                                            }
                                        </select>
                                    </div>

                                    <!-- Y-Axis Column -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Step 2: Y-Axis Column (Value) *</label>
                                        <small class="text-muted d-block mb-2">Select the column containing the concentration/measurement values</small>
                                        <select class="form-select" @bind="_selectedYAxisColumn" @bind:after="UpdatePreview">
                                            <option value="">-- Select value column --</option>
                                            @foreach (var header in _headers)
                                            {
                                                var isXAxis = header.Equals(_selectedXAxisColumn, StringComparison.OrdinalIgnoreCase);
                                                <option value="@header" disabled="@isXAxis">@header@(isXAxis ? " (X-axis)" : "")</option>
                                            }
                                        </select>
                                    </div>

                                    <!-- Variable Column -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Step 3: Variable Column *</label>
                                        <small class="text-muted d-block mb-2">
                                            Select the column that contains variable names (e.g., "variable" column with values like "nitrogen", "phosphorus", "copper"). 
                                            Each unique value in this column will become a separate series (line, column, or bar) in your chart.
                                        </small>
                                        @if (!string.IsNullOrEmpty(_selectedVariableColumn))
                                        {
                                            var uniqueVariableCount = GetUniqueVariableCount(_selectedVariableColumn);
                                            <div class="alert alert-success mb-2">
                                                <i class="bi bi-check-circle me-2"></i>
                                                <strong>Variable column selected:</strong> @_selectedVariableColumn
                                                <br />
                                                <small class="mt-1 d-block">
                                                    @if (uniqueVariableCount > 0)
                                                    {
                                                        <text><strong>@uniqueVariableCount unique variable(s) found.</strong> Each will become a separate series in your chart.</text>
                                                        <ul class="mb-0 mt-1">
                                                            <li><strong>Stacked types</strong> (Column Stacked, Bar Stacked, Area Stacked) - Stack variables on top of each other</li>
                                                            <li><strong>Clustered types</strong> (Column Clustered, Bar Clustered) - Show variables side-by-side</li>
                                                            <li><strong>Line types</strong> (Line, Line with Markers) - Show each variable as a separate line</li>
                                                        </ul>
                                                    }
                                                </small>
                                            </div>
                                        }
                                        <select class="form-select" @bind="_selectedVariableColumn" @bind:after="UpdatePreview">
                                            <option value="">-- Select variable column --</option>
                                            @foreach (var header in _headers)
                                            {
                                                var isXAxis = header.Equals(_selectedXAxisColumn, StringComparison.OrdinalIgnoreCase);
                                                var isYAxis = header.Equals(_selectedYAxisColumn, StringComparison.OrdinalIgnoreCase);
                                                <option value="@header" disabled="@(isXAxis || isYAxis)">
                                                    @header
                                                    @if (isXAxis)
                                                    {
                                                        <text> (X-axis)</text>
                                                    }
                                                    else if (isYAxis)
                                                    {
                                                        <text> (Y-axis)</text>
                                                    }
                                                </option>
                                            }
                                        </select>
                                    </div>

                                    <!-- Data Start Row -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Data Start Row</label>
                                        <small class="text-muted d-block mb-2">Row number where data starts (1-based, leave empty to start from row 2)</small>
                                        <InputNumber class="form-control" @bind-Value="_request.Configuration.DataStartRow" />
                                    </div>
                                }

                                <!-- Axis Titles -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">X-Axis Title</label>
                                    <InputText class="form-control" @bind-Value="_request.Configuration.XAxisTitle" placeholder="Leave empty for default" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Y-Axis Title</label>
                                    <InputText class="form-control" @bind-Value="_request.Configuration.YAxisTitle" placeholder="Leave empty for default" />
                                </div>

                                <!-- Legend Options -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="_request.Configuration.ShowLegend" />
                                        <label class="form-check-label fw-bold">Show Legend</label>
                                    </div>
                                </div>

                                @if (_request.Configuration.ShowLegend)
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Legend Position</label>
                                        <InputSelect class="form-select" @bind-Value="_request.Configuration.LegendPosition">
                                            <option value="Right">Right</option>
                                            <option value="Left">Left</option>
                                            <option value="Top">Top</option>
                                            <option value="Bottom">Bottom</option>
                                        </InputSelect>
                                    </div>
                                }

                                <!-- Data Analysis -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="_request.Configuration.IncludeDataAnalysis" />
                                        <label class="form-check-label fw-bold">Include Data Analysis</label>
                                        <small class="text-muted d-block">Generate AI-powered analysis of the data (requires ChatGPT)</small>
                                    </div>
                                </div>

                                <!-- AI Analysis Prompt Selection -->
                                @if (_request.Configuration.IncludeDataAnalysis)
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Analysis Prompt (Optional)</label>
                                        <small class="text-muted d-block mb-2">Select a custom prompt for data analysis. Leave empty to use default.</small>
                                        @if (_chartPrompts == null)
                                        {
                                            <div class="text-muted">Loading prompts...</div>
                                        }
                                        else if (!_chartPrompts.Any())
                                        {
                                            <div class="text-muted">No chart prompts available. <a href="/chatgpt/prompts/create">Create one</a> with Prompt Type = Chart.</div>
                                        }
                                        else
                                        {
                                            <InputSelect class="form-select" @bind-Value="_request.AnalysisPromptId">
                                                <option value="">Use Default Prompt</option>
                                                @foreach (var prompt in _chartPrompts)
                                                {
                                                    <option value="@prompt.Id">@prompt.Name @(!string.IsNullOrEmpty(prompt.Description) ? $" - {prompt.Description}" : "")</option>
                                                }
                                            </InputSelect>
                                        }
                                    </div>
                                }

                                <hr class="my-4" />

                                <!-- Advanced: Data Filtering -->
                                <h5 class="mb-3">Data Filtering (Optional)</h5>
                                <p class="text-muted small mb-3">Filter your data by selecting specific values from columns (e.g., specific stations or concentrations)</p>

                                @if (_headers != null && _headers.Any())
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Add Filter Column</label>
                                        <div class="input-group">
                                            <select class="form-select" @bind="_selectedFilterColumn">
                                                <option value="">-- Select column to filter --</option>
                                                @foreach (var header in _headers)
                                                {
                                                    @if (!_request.Filters.Any(f => f.ColumnName.Equals(header, StringComparison.OrdinalIgnoreCase)))
                                                    {
                                                        <option value="@header">@header</option>
                                                    }
                                                }
                                            </select>
                                            <button type="button" class="btn btn-outline-primary" @onclick="AddFilter" disabled="@string.IsNullOrEmpty(_selectedFilterColumn)">
                                                <i class="bi bi-plus-circle me-1"></i>Add Filter
                                            </button>
                                        </div>
                                    </div>

                                    @foreach (var filter in _request.Filters)
                                    {
                                        var searchTerm = _filterSearchTerms.ContainsKey(filter.ColumnName) ? _filterSearchTerms[filter.ColumnName] : string.Empty;
                                        var visibleValues = GetFilteredValues(filter.ColumnName, searchTerm);
                                        var visibleSelectedCount = visibleValues.Count(v => filter.SelectedValues.Contains(v, StringComparer.OrdinalIgnoreCase));
                                        var allVisibleSelected = visibleValues.Any() && visibleValues.All(v => filter.SelectedValues.Contains(v, StringComparer.OrdinalIgnoreCase));
                                        
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0">Filter: @filter.ColumnName</h6>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => RemoveFilter(filter)">
                                                        <i class="bi bi-x-circle"></i> Remove
                                                    </button>
                                                </div>
                                                <div class="small text-muted mb-2">Select values to include (leave empty to include all):</div>
                                                
                                                <!-- Search bar for filtering visible options -->
                                                <div class="mb-2">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               placeholder="Search to filter options..." 
                                                               value="@searchTerm"
                                                               @oninput="@((ChangeEventArgs e) => UpdateFilterSearch(filter.ColumnName, e.Value?.ToString() ?? string.Empty))" />
                                                        @if (!string.IsNullOrEmpty(searchTerm))
                                                        {
                                                            <button type="button" class="btn btn-outline-secondary" @onclick="() => ClearFilterSearch(filter.ColumnName)">
                                                                <i class="bi bi-x"></i>
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                                
                                                <!-- Select All / Deselect All buttons -->
                                                @if (visibleValues.Any())
                                                {
                                                    <div class="mb-2 d-flex gap-2">
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-primary" 
                                                                @onclick="() => SelectAllVisible(filter, visibleValues)"
                                                                disabled="@allVisibleSelected">
                                                            <i class="bi bi-check-square me-1"></i>Select All (@visibleValues.Count visible)
                                                        </button>
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-secondary" 
                                                                @onclick="() => DeselectAllVisible(filter, visibleValues)"
                                                                disabled="@(visibleSelectedCount == 0)">
                                                            <i class="bi bi-square me-1"></i>Deselect All Visible
                                                        </button>
                                                    </div>
                                                }
                                                
                                                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.5rem;">
                                                    @if (_filterValues.ContainsKey(filter.ColumnName))
                                                    {
                                                        @if (visibleValues.Any())
                                                        {
                                                            @foreach (var value in visibleValues)
                                                            {
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" 
                                                                           id="filter-@filter.ColumnName-@value" 
                                                                           checked="@filter.SelectedValues.Contains(value, StringComparer.OrdinalIgnoreCase)"
                                                                           @onchange="@((ChangeEventArgs e) => ToggleFilterValue(filter, value, e.Value?.ToString() == "True"))" />
                                                                    <label class="form-check-label" for="filter-@filter.ColumnName-@value">
                                                                        @value
                                                                    </label>
                                                                </div>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <div class="text-muted">
                                                                @if (!string.IsNullOrEmpty(searchTerm))
                                                                {
                                                                    <span>No values match "@searchTerm"</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>No values available</span>
                                                                }
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <div class="text-muted">Loading values...</div>
                                                    }
                                                </div>
                                                @if (filter.SelectedValues.Any())
                                                {
                                                    <div class="mt-2">
                                                        <small class="text-success">
                                                            <i class="bi bi-check-circle me-1"></i>@filter.SelectedValues.Count value(s) selected
                                                            @if (!string.IsNullOrEmpty(searchTerm) && visibleSelectedCount < filter.SelectedValues.Count)
                                                            {
                                                                <span class="text-muted">(@visibleSelectedCount visible)</span>
                                                            }
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                }

                                <hr class="my-4" />

                                <!-- Advanced: Data Sorting -->
                                <h5 class="mb-3">Data Sorting (Optional)</h5>
                                <p class="text-muted small mb-3">Sort your data by one or more columns before creating the chart. Sort order matters - first sort is applied first, then second, etc.</p>

                                @if (_headers != null && _headers.Any())
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Add Sort Column</label>
                                        <div class="input-group">
                                            <InputSelect class="form-select" @bind-Value="_selectedSortColumn">
                                                <option value="">-- Select column to sort by --</option>
                                                @foreach (var header in _headers)
                                                {
                                                    <option value="@header">@header</option>
                                                }
                                            </InputSelect>
                                            <button type="button" class="btn btn-outline-primary" @onclick="AddSort" disabled="@string.IsNullOrEmpty(_selectedSortColumn)">
                                                <i class="bi bi-plus-circle me-1"></i>Add
                                            </button>
                                        </div>
                                    </div>

                                    @if (_request.Sorts.Any())
                                    {
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Sort Order</label>
                                            <div class="border rounded p-3">
                                                @for (int i = 0; i < _request.Sorts.Count; i++)
                                                {
                                                    var sort = _request.Sorts[i];
                                                    var index = i;
                                                    <div class="d-flex align-items-center mb-2 p-2 bg-light rounded">
                                                        <div class="me-3">
                                                            <small class="text-muted">Sort #@(index + 1)</small>
                                                        </div>
                                                        <div class="flex-grow-1 me-2">
                                                            <strong>@sort.ColumnName</strong>
                                                        </div>
                                                        <div class="me-2">
                                                            <InputSelect class="form-select form-select-sm" style="width: 120px;" @bind-Value="sort.Direction" @bind-Value:after="UpdatePreview">
                                                                <option value="@SortDirection.Ascending">Ascending</option>
                                                                <option value="@SortDirection.Descending">Descending</option>
                                                            </InputSelect>
                                                        </div>
                                                        <div class="btn-group btn-group-sm">
                                                            @if (index > 0)
                                                            {
                                                                <button type="button" class="btn btn-outline-secondary" @onclick="() => MoveSortUp(index)" title="Move Up">
                                                                    <i class="bi bi-arrow-up"></i>
                                                                </button>
                                                            }
                                                            @if (index < _request.Sorts.Count - 1)
                                                            {
                                                                <button type="button" class="btn btn-outline-secondary" @onclick="() => MoveSortDown(index)" title="Move Down">
                                                                    <i class="bi bi-arrow-down"></i>
                                                                </button>
                                                            }
                                                            <button type="button" class="btn btn-outline-danger" @onclick="() => RemoveSort(sort)" title="Remove">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                }

                                <hr class="my-4" />

                                <!-- Advanced: Multiple Charts -->
                                <h5 class="mb-3">Multiple Charts by Station (Optional)</h5>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="_request.CreateMultipleCharts" />
                                        <label class="form-check-label fw-bold">Create Multiple Charts (One per Station)</label>
                                        <small class="text-muted d-block">
                                            Create separate worksheets, one for each station. Each worksheet will contain a chart with your selected variables (stacked, clustered, or as lines).
                                            <br />
                                            <strong>Example:</strong> If you have data from Station A, Station B, and Station C, you'll get 3 worksheets, each with a chart showing the selected variables for that station.
                                        </small>
                                    </div>
                                </div>

                                @if (_request.CreateMultipleCharts)
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Group By Column(s)</label>
                                        <small class="text-muted d-block mb-2">Select one or more columns to group by. Each unique combination will get its own worksheet and chart. Only filtered data will be used.</small>
                                        @if (_headers != null && _headers.Any())
                                        {
                                            <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                                @foreach (var header in _headers)
                                                {
                                                    var isSelected = _request.GroupByColumns.Contains(header, StringComparer.OrdinalIgnoreCase);
                                                    <div class="form-check">
                                                        <input class="form-check-input" 
                                                               type="checkbox" 
                                                               id="groupBy-@header" 
                                                               checked="@isSelected"
                                                               @onchange="@((ChangeEventArgs e) => ToggleGroupByColumn(header, e.Value?.ToString() == "True"))" />
                                                        <label class="form-check-label" for="groupBy-@header">
                                                            @header
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                    @if (_request.GroupByColumns.Any())
                                    {
                                        var groupCount = GetUniqueGroupCountForMultipleColumns(_request.GroupByColumns);
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Preview:</strong> Approximately <strong>@groupCount</strong> chart(s) will be created, one for each unique combination of:
                                            <strong>@string.Join(" + ", _request.GroupByColumns)</strong>
                                            @if (_request.Filters.Any(f => f.IsActive && _request.GroupByColumns.Contains(f.ColumnName, StringComparer.OrdinalIgnoreCase)))
                                            {
                                                <span class="text-muted d-block mt-1">(Only filtered values will be used)</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            Please select at least one column to group by.
                                        </div>
                                    }
                                }

                                <hr class="my-4" />

                                <!-- Save Chart Section -->
                                <h5 class="mb-3">Save Chart Configuration (Optional)</h5>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chart Name</label>
                                    <InputText class="form-control" @bind-Value="_chartName" placeholder="e.g., Monthly Sales Report" />
                                    <small class="text-muted">Give your chart configuration a name to save it for later use</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description (Optional)</label>
                                    <InputTextArea class="form-control" @bind-Value="_chartDescription" rows="2" placeholder="Brief description of this chart configuration" />
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary" @onclick="SaveChartAsync" disabled="@(string.IsNullOrWhiteSpace(_chartName) || _isSavingChart)">
                                        @if (_isSavingChart)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-save me-2"></i>
                                        }
                                        @(_currentSavedChartId.HasValue && _currentSavedChartId.Value > 0 ? "Update Saved Chart" : "Save Chart")
                                    </button>
                                    @if (_currentSavedChartId.HasValue && _currentSavedChartId.Value > 0)
                                    {
                                        <span class="ms-2 text-success">
                                            <i class="bi bi-check-circle me-1"></i>Chart saved (ID: @_currentSavedChartId.Value)
                                        </span>
                                    }
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg" disabled="@_isCreatingChart">
                                        @if (_isCreatingChart)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        }
                                        Create Chart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Data Preview -->
                    <div class="col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Data Preview</h5>
                            </div>
                            <div class="card-body">
                                @if (_request.DocumentId == 0)
                                {
                                    <div class="text-center text-muted py-5">
                                        <i class="bi bi-file-earmark-spreadsheet display-1"></i>
                                        <p class="mt-3">Select a document to preview its data</p>
                                    </div>
                                }
                                else if (_sheetDataList == null || !_sheetDataList.Any())
                                {
                                    <div class="text-center text-muted py-5">
                                        <div class="spinner-border" role="status"></div>
                                        <p class="mt-3">Loading data preview...</p>
                                    </div>
                                }
                                else if (_currentSheetData == null || !_currentSheetData.Rows.Any())
                                {
                                    <div class="alert alert-warning">
                                        No data found in the selected sheet.
                                    </div>
                                }
                                else
                                {
                                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                        <table class="table table-sm table-striped table-bordered">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    @foreach (var header in _headers)
                                                    {
                                                        <th>@header</th>
                                                    }
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in _previewRows)
                                                {
                                                    <tr>
                                                        @foreach (var cell in row)
                                                        {
                                                            <td>@cell</td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <small class="text-muted">
                                        @{
                                            var totalFilteredRows = ApplyFiltersToAllRows().Count;
                                            var totalAllRows = _allRowsData != null ? _allRowsData.Rows.Count - 1 : 0; // Subtract header
                                        }
                                        @if (_request.Sorts.Any())
                                        {
                                            <text>, sorted by @string.Join(", ", _request.Sorts.OrderBy(s => s.SortOrder).Select(s => $"{s.ColumnName} ({s.Direction})"))</text>
                                        }
                                        Showing first 50 rows of filtered data. 
                                        @if (_request.Filters.Any(f => f.IsActive))
                                        {
                                            <text>Filtered: @totalFilteredRows rows (from @totalAllRows total rows)</text>
                                        }
                                        else
                                        {
                                            <text>Total rows: @totalAllRows</text>
                                        }
                                    </small>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</FeatureGate>

@code {
    private ChartCreationRequest _request = new();
    private List<Document>? _availableDocuments;
    private List<Infrastructure.ExternalApis.SheetData>? _sheetDataList;
    private Infrastructure.ExternalApis.SheetData? _currentSheetData;
    private List<string> _headers = new();
    private List<List<string>> _previewRows = new();
    private Infrastructure.ExternalApis.SheetData? _allRowsData; // Store ALL rows for filtering
    private string _selectedXAxisColumn = string.Empty;
    private string _selectedYAxisColumn = string.Empty; // Y-axis column (value)
    private string _selectedVariableColumn = string.Empty; // Variable column (contains values like "nitrogen", "phosphorus")
    private string _selectedFilterColumn = string.Empty;
    private Dictionary<string, List<string>> _filterValues = new(); // Column name -> unique values
    private Dictionary<string, string> _filterSearchTerms = new(); // Column name -> search term for filtering visible options
    private string? _selectedSortColumn = string.Empty;
    private List<ChatGptPrompt>? _chartPrompts;
    private string? errorMessage;
    private bool _isLoading = true;
    private bool _isCreatingChart = false;
    private bool _isSavingChart = false;
    private string? userId;
    private int? tenantId;
    private List<SavedChart>? _savedCharts;
    private int _selectedSavedChartId = 0;
    private int? _currentSavedChartId = null;
    private string _chartName = string.Empty;
    private string? _chartDescription = string.Empty;

    [Parameter] [SupplyParameterFromQuery] public int? chartId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        tenantId = TenantService.GetCurrentTenantId();

        if (string.IsNullOrEmpty(userId) || tenantId == null)
        {
            errorMessage = "Unable to identify user or organization.";
            _isLoading = false;
            return;
        }

        // Check if Charts feature is enabled
        var isEnabled = await FeatureFlagService.IsEnabledAsync("Charts_Enabled");
        if (!isEnabled)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadDocuments();
        await LoadSavedChartsAsync();
        await LoadChartPromptsAsync();
        
        // If chartId parameter is provided, load that chart
        if (chartId.HasValue && chartId.Value > 0)
        {
            _selectedSavedChartId = chartId.Value;
            await LoadSavedChartAsync();
        }
        
        _isLoading = false;
    }

    private async Task LoadChartPromptsAsync()
    {
        if (tenantId == null)
            return;

        try
        {
            _chartPrompts = await PromptService.GetAllPromptsAsync(tenantId, PromptType.Chart);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chart prompts: {ex.Message}");
        }
    }

    private void ToggleGroupByColumn(string columnName, bool isSelected)
    {
        if (isSelected && !_request.GroupByColumns.Contains(columnName, StringComparer.OrdinalIgnoreCase))
        {
            _request.GroupByColumns.Add(columnName);
        }
        else if (!isSelected)
        {
            _request.GroupByColumns.RemoveAll(c => c.Equals(columnName, StringComparison.OrdinalIgnoreCase));
        }
        
        // Also update backward-compatible GroupByColumn for single column scenarios
        if (_request.GroupByColumns.Count == 1)
        {
            _request.GroupByColumn = _request.GroupByColumns.First();
        }
        else
        {
            _request.GroupByColumn = null;
        }
        
        StateHasChanged();
    }

    private int GetUniqueGroupCountForMultipleColumns(List<string> columnNames)
    {
        if (_allRowsData == null || !columnNames.Any())
            return 0;

        var headers = _allRowsData.Rows[0];
        var columnIndices = columnNames
            .Select(colName => headers.IndexOf(colName))
            .Where(idx => idx >= 0)
            .ToList();

        if (columnIndices.Count != columnNames.Count)
            return 0;

        // Get filtered rows
        var filteredRows = ApplyFiltersToAllRows();
        var sortedRows = ApplySortingToRows(filteredRows);
        
        // Get unique combinations (sorting doesn't affect unique count, but use sorted data for consistency)
        var uniqueCombinations = sortedRows
            .Where(row => columnIndices.All(idx => idx < row.Count))
            .Select(row => string.Join("|", columnIndices.Select(idx => row[idx]?.Trim() ?? "")))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .Count();

        return uniqueCombinations;
    }

    private async Task LoadSavedChartsAsync()
    {
        if (string.IsNullOrEmpty(userId) || tenantId == null)
            return;

        try
        {
            _savedCharts = await ChartService.GetSavedChartsAsync(userId, tenantId.Value);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading saved charts: {ex.Message}");
        }
    }

    private async Task LoadSavedChartAsync()
    {
        if (_selectedSavedChartId == 0 || string.IsNullOrEmpty(userId) || tenantId == null)
        {
            _currentSavedChartId = null;
            _chartName = string.Empty;
            _chartDescription = string.Empty;
            return;
        }

        try
        {
            var savedRequest = await ChartService.LoadSavedChartAsync(_selectedSavedChartId, userId, tenantId.Value);
            if (savedRequest == null)
            {
                errorMessage = "Failed to load saved chart configuration.";
                return;
            }

            var savedChart = _savedCharts?.FirstOrDefault(c => c.Id == _selectedSavedChartId);
            if (savedChart != null)
            {
                _chartName = savedChart.Name;
                _chartDescription = savedChart.Description;
                _currentSavedChartId = savedChart.Id;
            }

            // Load the configuration
            _request = savedRequest;

            // Restore x-axis, y-axis, and variable column selections from loaded configuration
            _selectedXAxisColumn = _request.Configuration.XAxisColumns?.FirstOrDefault() ?? string.Empty;
            _selectedYAxisColumn = _request.Configuration.YAxisColumns?.FirstOrDefault() ?? string.Empty;
            _selectedVariableColumn = _request.Configuration.VariableColumn ?? string.Empty;

            // Restore grouping columns (support both old and new format)
            if (_request.GroupByColumns != null && _request.GroupByColumns.Any())
            {
                // Already in new format
            }
            else if (!string.IsNullOrEmpty(_request.GroupByColumn))
            {
                // Convert from old format to new format
                _request.GroupByColumns = new List<string> { _request.GroupByColumn };
            }
            
            // Ensure Sorts list is initialized if it's null (backward compatibility)
            if (_request.Sorts == null)
            {
                _request.Sorts = new List<ChartSort>();
            }

            // Load document data if document is selected
            if (_request.DocumentId > 0)
            {
                await OnDocumentSelectedAsync();
            }

            // Update UI
            UpdatePreview();
            StateHasChanged();

            await NotificationService.ShowSuccessAsync("Chart configuration loaded successfully!");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading saved chart: {ex.Message}";
        }
    }

    private async Task SaveChartAsync()
    {
        if (string.IsNullOrWhiteSpace(_chartName))
        {
            errorMessage = "Please enter a chart name.";
            return;
        }

        if (string.IsNullOrEmpty(userId) || tenantId == null)
        {
            errorMessage = "Unable to identify user or organization.";
            return;
        }

        // Validate that we have a valid configuration
        if (_request.DocumentId == 0)
        {
            errorMessage = "Please select a document before saving.";
            return;
        }

        _isSavingChart = true;
        errorMessage = null;

        try
        {
            // Update request with current selections before saving
            _request.Configuration.XAxisColumns = new List<string> { _selectedXAxisColumn };
            _request.Configuration.YAxisColumns = new List<string> { _selectedYAxisColumn };
            _request.Configuration.VariableColumn = _selectedVariableColumn;

            var savedChartId = await ChartService.SaveChartAsync(_request, _chartName, _chartDescription, userId, tenantId.Value, _currentSavedChartId);
            _currentSavedChartId = savedChartId;

            // Reload saved charts list
            await LoadSavedChartsAsync();

            await NotificationService.ShowSuccessAsync(_currentSavedChartId.HasValue && _selectedSavedChartId == savedChartId 
                ? "Chart configuration updated successfully!" 
                : "Chart configuration saved successfully!");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving chart: {ex.Message}";
        }
        finally
        {
            _isSavingChart = false;
            StateHasChanged();
        }
    }

    private async Task DeleteCurrentSavedChartAsync()
    {
        if (!_currentSavedChartId.HasValue || string.IsNullOrEmpty(userId) || tenantId == null)
            return;

        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the saved chart '{_chartName}'?");
            if (!confirmed)
                return;

            var deleted = await ChartService.DeleteSavedChartAsync(_currentSavedChartId.Value, userId, tenantId.Value);
            if (deleted)
            {
                _currentSavedChartId = null;
                _selectedSavedChartId = 0;
                _chartName = string.Empty;
                _chartDescription = string.Empty;
                await LoadSavedChartsAsync();
                await NotificationService.ShowSuccessAsync("Saved chart deleted successfully!");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting saved chart: {ex.Message}";
        }
    }

    private async Task LoadDocuments()
    {
        if (string.IsNullOrEmpty(userId) || tenantId == null)
            return;

        try
        {
            var allDocuments = await DocumentService.GetAllDocumentsAsync(userId, tenantId.Value);
            
            // Filter for Excel and CSV files only
            _availableDocuments = allDocuments
                .Where(d => 
                    d.ContentType.Contains("spreadsheet") || 
                    d.ContentType.Contains("excel") ||
                    d.ContentType.Contains("csv") ||
                    d.FileName.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase) ||
                    d.FileName.EndsWith(".xls", StringComparison.OrdinalIgnoreCase) ||
                    d.FileName.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
                .OrderByDescending(d => d.UploadedAt)
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading documents: {ex.Message}";
        }
    }

    private async Task OnDocumentSelectedAsync()
    {
        if (_request.DocumentId == 0)
        {
            _sheetDataList = null;
            _currentSheetData = null;
            _allRowsData = null;
            _headers.Clear();
            _previewRows.Clear();
            _selectedXAxisColumn = string.Empty;
            _selectedYAxisColumn = string.Empty;
            _selectedVariableColumn = string.Empty;
            _request.Filters.Clear();
            _request.Sorts.Clear();
            _filterValues.Clear();
            _filterSearchTerms.Clear();
            _selectedSortColumn = string.Empty;
            return;
        }

        try
        {
            _isLoading = true;
            StateHasChanged();
            
            // Get ALL rows for filtering and chart creation (maxRows: 0 = all rows)
            _sheetDataList = await DocumentService.GetStructuredDataAsync(_request.DocumentId, userId!, tenantId!.Value, maxRows: 0);
            
            if (_sheetDataList != null && _sheetDataList.Any())
            {
                // Reset sheet name to first sheet
                _request.SheetName = string.Empty;
                
                // Use first sheet - store ALL rows
                _currentSheetData = _sheetDataList.First();
                _allRowsData = _currentSheetData; // Keep a copy of all rows

                UpdatePreview();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading document data: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSheetSelectionChanged()
    {
        if (_sheetDataList == null || !_sheetDataList.Any())
            return;

        // Update current sheet data based on selection - get ALL rows
        _currentSheetData = string.IsNullOrEmpty(_request.SheetName)
            ? _sheetDataList.First()
            : _sheetDataList.FirstOrDefault(s => s.SheetName.Equals(_request.SheetName, StringComparison.OrdinalIgnoreCase)) ?? _sheetDataList.First();
        
        _allRowsData = _currentSheetData; // Keep a copy of all rows

        UpdatePreview();
        
        // Clear axis selections, filters, and sorts when sheet changes
        _selectedXAxisColumn = string.Empty;
        _selectedYAxisColumn = string.Empty;
        _selectedVariableColumn = string.Empty;
        _request.Filters.Clear();
        _request.Sorts.Clear();
        _request.GroupByColumns.Clear();
        _request.GroupByColumn = null;
        _filterValues.Clear();
        _filterSearchTerms.Clear();
        _selectedSortColumn = string.Empty;
    }

    private void UpdatePreview()
    {
        if (_allRowsData == null || !_allRowsData.Rows.Any())
        {
            _headers.Clear();
            _previewRows.Clear();
            // Don't clear _filterValues here - keep them for the dropdowns
            return;
        }

        // First row is headers
        _headers = _allRowsData.Rows[0];

        // Apply filters to get filtered data
        var filteredRows = ApplyFiltersToAllRows();
        
        // Apply sorting to filtered data
        var sortedRows = ApplySortingToRows(filteredRows);

        // Preview rows (limit to 50 for performance) - show filtered and sorted results
        _previewRows = sortedRows
            .Take(50)
            .ToList();

        // Extract unique values for each column from ALL rows (for filtering dropdowns)
        // Always reload from ALL rows to ensure we have complete lists, regardless of any filters
        // Remove the 500 limit to show all values - the search and virtual scrolling will handle performance
        foreach (var header in _headers)
        {
            var columnIndex = _headers.IndexOf(header);
            var uniqueValues = _allRowsData.Rows
                .Skip(1) // Skip header
                .Where(row => columnIndex < row.Count && !string.IsNullOrWhiteSpace(row[columnIndex]))
                .Select(row => row[columnIndex].Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(v => v)
                .ToList(); // Removed .Take(500) to show all values
            
            _filterValues[header] = uniqueValues;
        }

        // Update chart configuration defaults
        if (_headers.Any() && string.IsNullOrEmpty(_request.Configuration.Title))
        {
            var doc = _availableDocuments?.FirstOrDefault(d => d.Id == _request.DocumentId);
            _request.Configuration.Title = $"Chart from {doc?.Title ?? doc?.FileName ?? "Data"}";
        }
    }

    private void EnsureFilterValuesLoaded()
    {
        if (_allRowsData == null || !_allRowsData.Rows.Any() || _headers == null || !_headers.Any())
            return;

        // Always reload filter values from ALL rows to ensure complete lists
        // This ensures that when a new filter is added, it shows all possible values from the entire dataset
        // Removed the 500 limit to show all values
        foreach (var header in _headers)
        {
            var columnIndex = _headers.IndexOf(header);
            var uniqueValues = _allRowsData.Rows
                .Skip(1) // Skip header
                .Where(row => columnIndex < row.Count && !string.IsNullOrWhiteSpace(row[columnIndex]))
                .Select(row => row[columnIndex].Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(v => v)
                .ToList(); // Removed .Take(500) to show all values
            
            _filterValues[header] = uniqueValues;
        }
    }

    private List<string> GetFilteredValues(string columnName, string searchTerm)
    {
        if (!_filterValues.ContainsKey(columnName))
            return new List<string>();

        var allValues = _filterValues[columnName];
        
        if (string.IsNullOrWhiteSpace(searchTerm))
            return allValues;

        var searchLower = searchTerm.ToLowerInvariant();
        return allValues
            .Where(v => v.ToLowerInvariant().Contains(searchLower))
            .ToList();
    }

    private void UpdateFilterSearch(string columnName, string searchTerm)
    {
        _filterSearchTerms[columnName] = searchTerm ?? string.Empty;
        StateHasChanged();
    }

    private void ClearFilterSearch(string columnName)
    {
        if (_filterSearchTerms.ContainsKey(columnName))
        {
            _filterSearchTerms.Remove(columnName);
        }
        StateHasChanged();
    }

    private void SelectAllVisible(ChartFilter filter, List<string> visibleValues)
    {
        foreach (var value in visibleValues)
        {
            if (!filter.SelectedValues.Contains(value, StringComparer.OrdinalIgnoreCase))
            {
                filter.SelectedValues.Add(value);
            }
        }
        UpdatePreview();
        StateHasChanged();
    }

    private void DeselectAllVisible(ChartFilter filter, List<string> visibleValues)
    {
        foreach (var value in visibleValues)
        {
            filter.SelectedValues.RemoveAll(v => v.Equals(value, StringComparison.OrdinalIgnoreCase));
        }
        UpdatePreview();
        StateHasChanged();
    }

    private List<List<string>> ApplyFiltersToAllRows()
    {
        if (_allRowsData == null || _allRowsData.Rows.Count <= 1)
            return new List<List<string>>();

        var headers = _allRowsData.Rows[0];
        var activeFilters = _request.Filters.Where(f => f.IsActive && f.SelectedValues.Any()).ToList();

        // If no active filters, return all rows (except header)
        if (!activeFilters.Any())
        {
            return _allRowsData.Rows.Skip(1).ToList();
        }

        var filtered = new List<List<string>>();
        
        // Filter all rows based on active filters
        for (int rowIndex = 1; rowIndex < _allRowsData.Rows.Count; rowIndex++)
        {
            var row = _allRowsData.Rows[rowIndex];
            bool includeRow = true;

            foreach (var filter in activeFilters)
            {
                var columnIndex = headers.IndexOf(filter.ColumnName);
                if (columnIndex >= 0 && columnIndex < row.Count)
                {
                    var cellValue = row[columnIndex]?.Trim() ?? string.Empty;
                    if (!filter.SelectedValues.Contains(cellValue, StringComparer.OrdinalIgnoreCase))
                    {
                        includeRow = false;
                        break;
                    }
                }
            }

            if (includeRow)
            {
                filtered.Add(row);
            }
        }

        return filtered;
    }

    private List<List<string>> ApplySortingToRows(List<List<string>> rows)
    {
        if (!_request.Sorts.Any() || !rows.Any())
            return rows;

        var headers = _allRowsData?.Rows[0] ?? new List<string>();
        if (!headers.Any())
            return rows;

        IOrderedEnumerable<List<string>>? orderedRows = null;
        bool firstSort = true;

        foreach (var sort in _request.Sorts.OrderBy(s => s.SortOrder))
        {
            var columnIndex = headers.IndexOf(sort.ColumnName);
            if (columnIndex < 0) continue;

            if (firstSort)
            {
                if (sort.Direction == SortDirection.Ascending)
                {
                    orderedRows = rows.OrderBy(row => GetSortValue(row, columnIndex));
                }
                else
                {
                    orderedRows = rows.OrderByDescending(row => GetSortValue(row, columnIndex));
                }
                firstSort = false;
            }
            else
            {
                if (sort.Direction == SortDirection.Ascending)
                {
                    orderedRows = orderedRows!.ThenBy(row => GetSortValue(row, columnIndex));
                }
                else
                {
                    orderedRows = orderedRows!.ThenByDescending(row => GetSortValue(row, columnIndex));
                }
            }
        }

        return orderedRows?.ToList() ?? rows;
    }

    private object GetSortValue(List<string> row, int columnIndex)
    {
        if (columnIndex >= row.Count)
            return string.Empty;

        var cellValue = row[columnIndex]?.Trim() ?? string.Empty;
        
        // Try to parse as numeric for proper numeric sorting
        if (double.TryParse(cellValue, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out double numValue))
        {
            return numValue;
        }
        
        // Try to parse as date for proper date sorting
        if (DateTime.TryParse(cellValue, out DateTime dateValue))
        {
            return dateValue;
        }
        
        // String comparison
        return cellValue;
    }

    private void AddFilter()
    {
        if (string.IsNullOrEmpty(_selectedFilterColumn))
            return;

        if (!_request.Filters.Any(f => f.ColumnName.Equals(_selectedFilterColumn, StringComparison.OrdinalIgnoreCase)))
        {
            _request.Filters.Add(new ChartFilter
            {
                ColumnName = _selectedFilterColumn,
                SelectedValues = new List<string>()
            });
            _selectedFilterColumn = string.Empty;
            
            // Ensure filter values are loaded for this column
            EnsureFilterValuesLoaded();
            StateHasChanged();
        }
    }

    private void RemoveFilter(ChartFilter filter)
    {
        _request.Filters.Remove(filter);
        // Update preview when filter is removed
        UpdatePreview();
    }

    private void AddSort()
    {
        if (string.IsNullOrEmpty(_selectedSortColumn))
            return;

        // Check if this column is already in the sort list
        if (_request.Sorts.Any(s => s.ColumnName.Equals(_selectedSortColumn, StringComparison.OrdinalIgnoreCase)))
        {
            return; // Already added
        }

        var newSort = new ChartSort
        {
            ColumnName = _selectedSortColumn,
            Direction = SortDirection.Ascending,
            SortOrder = _request.Sorts.Count
        };

        _request.Sorts.Add(newSort);
        _selectedSortColumn = string.Empty;
        
        // Update preview to reflect sorting
        UpdatePreview();
        StateHasChanged();
    }

    private void RemoveSort(ChartSort sort)
    {
        var removedIndex = _request.Sorts.IndexOf(sort);
        _request.Sorts.Remove(sort);
        
        // Reorder remaining sorts
        for (int i = 0; i < _request.Sorts.Count; i++)
        {
            _request.Sorts[i].SortOrder = i;
        }
        
        // Update preview to reflect sorting
        UpdatePreview();
        StateHasChanged();
    }

    private void MoveSortUp(int index)
    {
        if (index <= 0 || index >= _request.Sorts.Count)
            return;

        var sort = _request.Sorts[index];
        _request.Sorts.RemoveAt(index);
        _request.Sorts.Insert(index - 1, sort);
        
        // Update sort orders
        for (int i = 0; i < _request.Sorts.Count; i++)
        {
            _request.Sorts[i].SortOrder = i;
        }
        
        UpdatePreview();
        StateHasChanged();
    }

    private void MoveSortDown(int index)
    {
        if (index < 0 || index >= _request.Sorts.Count - 1)
            return;

        var sort = _request.Sorts[index];
        _request.Sorts.RemoveAt(index);
        _request.Sorts.Insert(index + 1, sort);
        
        // Update sort orders
        for (int i = 0; i < _request.Sorts.Count; i++)
        {
            _request.Sorts[i].SortOrder = i;
        }
        
        UpdatePreview();
        StateHasChanged();
    }

    private void ToggleFilterValue(ChartFilter filter, string value, bool isSelected)
    {
        if (isSelected && !filter.SelectedValues.Contains(value, StringComparer.OrdinalIgnoreCase))
        {
            filter.SelectedValues.Add(value);
        }
        else if (!isSelected)
        {
            filter.SelectedValues.RemoveAll(v => v.Equals(value, StringComparison.OrdinalIgnoreCase));
        }
        
        // Update preview when filter changes (synchronous - no database calls)
        UpdatePreview();
        StateHasChanged();
    }

    private int GetUniqueGroupCount(string columnName)
    {
        if (_allRowsData == null || string.IsNullOrEmpty(columnName))
            return 0;

        var columnIndex = _headers.IndexOf(columnName);
        if (columnIndex < 0)
            return 0;

        // Apply active filters to ALL rows
        var filteredRows = ApplyFiltersToAllRows();

        var uniqueValues = filteredRows
            .Where(row => columnIndex < row.Count && !string.IsNullOrWhiteSpace(row[columnIndex]))
            .Select(row => row[columnIndex].Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .Count();

        return uniqueValues;
    }

    private int GetUniqueVariableCount(string variableColumnName)
    {
        if (_allRowsData == null || string.IsNullOrEmpty(variableColumnName))
            return 0;

        var columnIndex = _headers.IndexOf(variableColumnName);
        if (columnIndex < 0)
            return 0;

        // Apply active filters to ALL rows
        var filteredRows = ApplyFiltersToAllRows();

        var uniqueValues = filteredRows
            .Where(row => columnIndex < row.Count && !string.IsNullOrWhiteSpace(row[columnIndex]))
            .Select(row => row[columnIndex].Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .Count();

        return uniqueValues;
    }

    private async Task CreateChartAsync()
    {
        if (string.IsNullOrEmpty(userId) || tenantId == null)
        {
            errorMessage = "Unable to identify user or organization.";
            return;
        }

        // Validate selections
        if (_request.DocumentId == 0)
        {
            errorMessage = "Please select a document.";
            return;
        }

        if (string.IsNullOrEmpty(_selectedXAxisColumn))
        {
            errorMessage = "Please select an X-axis column.";
            return;
        }

        if (string.IsNullOrEmpty(_selectedYAxisColumn))
        {
            errorMessage = "Please select a Y-axis column (value) in Step 2.";
            return;
        }

        if (string.IsNullOrEmpty(_selectedVariableColumn))
        {
            errorMessage = "Please select a Variable column in Step 3.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_request.Configuration.Title))
        {
            errorMessage = "Please enter a chart title.";
            return;
        }

        // Validate grouping columns if creating multiple charts
        // Allow empty if filters are active (will be auto-populated from filters)
        if (_request.CreateMultipleCharts)
        {
            bool hasGroupingColumns = (_request.GroupByColumns != null && _request.GroupByColumns.Any()) || !string.IsNullOrEmpty(_request.GroupByColumn);
            bool hasActiveFilters = _request.Filters.Any(f => f.IsActive);
            
            if (!hasGroupingColumns && !hasActiveFilters)
            {
                errorMessage = "Please select at least one column to group by for multiple charts, or add data filters (filter columns will be used for grouping).";
                return;
            }
        }

        // Update request with selected columns
        _request.Configuration.XAxisColumns = new List<string> { _selectedXAxisColumn };
        _request.Configuration.YAxisColumns = new List<string> { _selectedYAxisColumn };
        _request.Configuration.VariableColumn = _selectedVariableColumn;
        
        // Ensure GroupByColumns is populated (support backward compatibility)
        if (_request.CreateMultipleCharts)
        {
            if (!_request.GroupByColumns.Any() && !string.IsNullOrEmpty(_request.GroupByColumn))
            {
                _request.GroupByColumns = new List<string> { _request.GroupByColumn };
            }
        }

        _isCreatingChart = true;
        errorMessage = null;

        try
        {
            var result = await ChartService.CreateChartAsync(_request, userId, tenantId.Value);

            // Download the file
            await JSRuntime.InvokeVoidAsync("downloadFile", result.FileName, Convert.ToBase64String(result.ExcelFileBytes), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            var message = result.ChartsCreated > 1
                ? $"Successfully created {result.ChartsCreated} charts in {result.ChartsCreated} worksheets! The file is downloading."
                : "Chart created successfully! The file is downloading.";
            
            await NotificationService.ShowSuccessAsync(message);

            // If chart is saved, update it with current configuration
            if (_currentSavedChartId.HasValue && _currentSavedChartId.Value > 0 && !string.IsNullOrWhiteSpace(_chartName))
            {
                try
                {
                    _request.Configuration.XAxisColumns = new List<string> { _selectedXAxisColumn };
                    _request.Configuration.YAxisColumns = new List<string> { _selectedYAxisColumn };
                    _request.Configuration.VariableColumn = _selectedVariableColumn;
                    await ChartService.SaveChartAsync(_request, _chartName, _chartDescription, userId, tenantId.Value, _currentSavedChartId);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error auto-updating saved chart: {ex.Message}");
                }
            }

            // Optionally show data analysis (only for single charts)
            if (!string.IsNullOrEmpty(result.DataAnalysis) && result.ChartsCreated == 1)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Data Analysis:\n\n{result.DataAnalysis}");
            }

            // Reset form or navigate
            Navigation.NavigateTo("/charts");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating chart: {ex.Message}";
        }
        finally
        {
            _isCreatingChart = false;
        }
    }
}
