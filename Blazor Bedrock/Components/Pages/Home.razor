@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Blazor_Bedrock.Data.Models
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Services.Tenant
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ITenantService TenantService
@inject NavigationManager Navigation
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<div class="container-fluid mt-4">
    @if (_showOrganizationPrompt)
    {
        <div class="card shadow mb-4">
            <div class="card-body p-5">
                <h4 class="mb-4">Welcome to Blazor Bedrock</h4>
                <p class="mb-4">
                    To get started, you need to create an organization. This will be your workspace where you can manage users, roles, and access all the application features.
                </p>
                <button class="btn btn-primary btn-lg mt-4" @onclick="NavigateToCreateOrganization">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create Organization
                </button>
            </div>
        </div>
    }
    else
    {
        <h3 class="mb-4">Welcome to Blazor Bedrock</h3>
        
        @if (_authState != null)
        {
            <div class="alert @(_authState.User?.Identity?.IsAuthenticated == true ? "alert-success" : "alert-info") mb-4" role="alert">
                <strong>Authentication Status:</strong> 
                @if (_authState.User?.Identity?.IsAuthenticated == true)
                {
                    <text>Authenticated as @_authState.User.Identity.Name</text>
                    @if (_currentUser != null)
                    {
                        <text> (@_currentUser.FirstName @_currentUser.LastName - @_currentUser.Email)</text>
                    }
                }
                else
                {
                    <text>Not Authenticated</text>
                }
            </div>
        }
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow">
                    <div class="card-body">
                        <h6 class="card-title">Multi-Tenant Application</h6>
                        <p class="card-text">
                            This is a comprehensive bedrock application with multi-tenant support, 
                            user management, role-based permissions, and modular architecture.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card shadow">
                    <div class="card-body">
                        <h6 class="card-title">Features</h6>
                        <ul class="card-text">
                            <li>User & Role Management</li>
                            <li>ChatGPT Integration</li>
                            <li>Stripe Payments</li>
                            <li>Migration Management</li>
                            <li>Application Logger</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private AuthenticationState? _authState;
    private ApplicationUser? _currentUser;
    private bool _showOrganizationPrompt = false;

    protected override async Task OnInitializedAsync()
    {
        _authState = await AuthStateProvider.GetAuthenticationStateAsync();
        
        if (_authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = _authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                var user = await UserManager.GetUserAsync(_authState.User);
                userId = user?.Id;
            }

            if (!string.IsNullOrEmpty(userId))
            {
                await DbSync.ExecuteAsync(async () =>
                {
                    _currentUser = await UserManager.FindByIdAsync(userId);
                });

                // Check if user has an organization
                var tenants = await TenantService.GetUserTenantsAsync(userId);
                var currentTenantId = TenantService.GetCurrentTenantId();
                
                // Show prompt if no tenants or no current tenant selected
                if (!tenants.Any() || !currentTenantId.HasValue)
                {
                    _showOrganizationPrompt = true;
                }
            }
        }
    }

    private void NavigateToCreateOrganization()
    {
        Navigation.NavigateTo("/tenant/create-organization");
    }
}
