@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Blazor_Bedrock.Data.Models
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.FeatureFlag
@using Blazor_Bedrock.Services.Subscription
@using Blazor_Bedrock.Data
@using Microsoft.EntityFrameworkCore
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ITenantService TenantService
@inject NavigationManager Navigation
@inject IDatabaseSyncService DbSync
@inject IFeatureFlagService FeatureFlagService
@inject ISubscriptionLimitationService LimitationService
@inject ApplicationDbContext _context
@inject IConfiguration Configuration
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<div class="container-fluid mt-4">
    @if (_showOrganizationPrompt)
    {
        <div class="card shadow-lg border-0 mb-4" style="max-width: 800px; margin: 0 auto;">
            <div class="card-body p-5 text-center">
                <div class="mb-4">
                    <i class="bi bi-building" style="font-size: 4rem; color: var(--bs-primary);"></i>
                </div>
                <h2 class="mb-4">Welcome to @_projectTitle</h2>
                <p class="lead mb-4">
                    To get started, you need to create an organization. This will be your workspace where you can manage users, roles, and access all the application features.
                </p>
                <button class="btn btn-primary btn-lg mt-4" @onclick="NavigateToCreateOrganization">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create Organization
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="mb-5">
            <h1 class="display-5 fw-bold mb-3">Welcome to @_projectTitle</h1>
            @if (_authState?.User?.Identity?.IsAuthenticated == true && _currentUser != null)
            {
                <p class="lead text-muted">
                    Hello, <strong>@_currentUser.FirstName @_currentUser.LastName</strong>! 
                    Here's what's available in your workspace.
                </p>
            }
            else
            {
                <p class="lead text-muted">
                    Discover the powerful features available in this application.
                </p>
            }
        </div>

        @if (_enabledFeatures.Any())
        {
            <div class="row g-4 mb-5">
                @foreach (var feature in _enabledFeatures)
                {
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm border-0 feature-card" style="transition: transform 0.2s, box-shadow 0.2s;">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="feature-icon me-3" style="font-size: 2.5rem; color: var(--bs-primary);">
                                        <i class="@feature.Icon"></i>
                                    </div>
                                    <h5 class="card-title mb-0">@feature.Title</h5>
                                </div>
                                <p class="card-text text-muted mb-3">@feature.Description</p>
                                @if (!string.IsNullOrEmpty(feature.Link))
                                {
                                    <a href="@feature.Link" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-arrow-right me-1"></i>
                                        @feature.LinkText
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                No features are currently enabled. Contact your administrator to enable features.
            </div>
        }

        @* Subscription Information *@
        @if (_subscriptionsEnabled && _subscriptionInfo != null)
        {
            <div class="row mt-5 mb-4">
                <div class="col-md-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-credit-card me-2"></i>
                                Subscription Information
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            @if (_subscriptionInfo.PlanName != null)
                            {
                                <div class="mb-3">
                                    <strong>Plan:</strong> @_subscriptionInfo.PlanName
                                </div>
                                <div class="row g-3">
                                    @if (_subscriptionInfo.UsersLimit.HasValue)
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                <span><i class="bi bi-people me-2"></i>Users:</span>
                                                <span class="badge @GetBadgeClass(_subscriptionInfo.UsersCurrent, _subscriptionInfo.UsersLimit.Value)">
                                                    @_subscriptionInfo.UsersCurrent / @_subscriptionInfo.UsersLimit.Value
                                                </span>
                                            </div>
                                        </div>
                                    }
                                    @if (_subscriptionInfo.DocumentsLimit.HasValue)
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                <span><i class="bi bi-file-earmark me-2"></i>Documents:</span>
                                                <span class="badge @GetBadgeClass(_subscriptionInfo.DocumentsCurrent, _subscriptionInfo.DocumentsLimit.Value)">
                                                    @_subscriptionInfo.DocumentsCurrent / @_subscriptionInfo.DocumentsLimit.Value
                                                </span>
                                            </div>
                                        </div>
                                    }
                                    @if (_subscriptionInfo.ChartsLimit.HasValue)
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                <span><i class="bi bi-bar-chart me-2"></i>Charts:</span>
                                                <span class="badge @GetBadgeClass(_subscriptionInfo.ChartsCurrent, _subscriptionInfo.ChartsLimit.Value)">
                                                    @_subscriptionInfo.ChartsCurrent / @_subscriptionInfo.ChartsLimit.Value
                                                </span>
                                            </div>
                                        </div>
                                    }
                                    @if (_subscriptionInfo.ConversationsLimit.HasValue)
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                <span><i class="bi bi-chat-dots me-2"></i>Conversations:</span>
                                                <span class="badge @GetBadgeClass(_subscriptionInfo.ConversationsCurrent, _subscriptionInfo.ConversationsLimit.Value)">
                                                    @_subscriptionInfo.ConversationsCurrent / @_subscriptionInfo.ConversationsLimit.Value
                                                </span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    No subscription plan assigned. All features are unlimited.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="row mt-5">
            <div class="col-md-12">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            About This Application
                        </h5>
                        <p class="card-text mb-0">
                            This is a comprehensive multi-tenant application with role-based access control, 
                            feature flags, and a modular architecture. Manage users, roles, documents, 
                            and leverage AI-powered features all from one platform.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
</style>

@code {
    private AuthenticationState? _authState;
    private ApplicationUser? _currentUser;
    private bool _showOrganizationPrompt = false;
    private string _projectTitle = "Blazor Bedrock";
    private List<FeatureInfo> _enabledFeatures = new();
    private bool _subscriptionsEnabled = false;
    private SubscriptionInfo? _subscriptionInfo;

    private class SubscriptionInfo
    {
        public string? PlanName { get; set; }
        public int? UsersLimit { get; set; }
        public int UsersCurrent { get; set; }
        public int? DocumentsLimit { get; set; }
        public int DocumentsCurrent { get; set; }
        public int? ChartsLimit { get; set; }
        public int ChartsCurrent { get; set; }
        public int? ConversationsLimit { get; set; }
        public int ConversationsCurrent { get; set; }
    }

    private class FeatureInfo
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
        public string? Link { get; set; }
        public string LinkText { get; set; } = "Explore";
    }

    protected override async Task OnInitializedAsync()
    {
        // Read project title from configuration
        _projectTitle = Configuration["Application:ProjectTitle"] ?? "Blazor Bedrock";

        _authState = await AuthStateProvider.GetAuthenticationStateAsync();
        
        if (_authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = _authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                var user = await UserManager.GetUserAsync(_authState.User);
                userId = user?.Id;
            }

            if (!string.IsNullOrEmpty(userId))
            {
                await DbSync.ExecuteAsync(async () =>
                {
                    _currentUser = await UserManager.FindByIdAsync(userId);
                });

                // Check if user has an organization
                var tenants = await TenantService.GetUserTenantsAsync(userId);
                var currentTenantId = TenantService.GetCurrentTenantId();
                
                // Show prompt if no tenants or no current tenant selected
                if (!tenants.Any() || !currentTenantId.HasValue)
                {
                    _showOrganizationPrompt = true;
                }
                else
                {
                    // Load enabled features
                    await LoadEnabledFeaturesAsync(userId, currentTenantId.Value);
                    
                    // Load subscription information
                    await LoadSubscriptionInfoAsync(currentTenantId.Value);
                }
            }
        }
        else
        {
            // For non-authenticated users, show public features
            await LoadPublicFeaturesAsync();
        }
    }

    private async Task LoadSubscriptionInfoAsync(int tenantId)
    {
        _subscriptionsEnabled = await FeatureFlagService.IsEnabledAsync("Subscriptions");
        
        if (_subscriptionsEnabled)
        {
            var limitations = await LimitationService.GetTenantLimitationsAsync(tenantId);
            
            if (limitations != null)
            {
                _subscriptionInfo = new SubscriptionInfo
                {
                    PlanName = "Active Plan", // We'll get the actual plan name from the tenant
                    UsersLimit = limitations.MaxUsers,
                    UsersCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Users),
                    DocumentsLimit = limitations.MaxDocuments,
                    DocumentsCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Documents),
                    ChartsLimit = limitations.MaxCharts,
                    ChartsCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Charts),
                    ConversationsLimit = limitations.MaxConversations,
                    ConversationsCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Conversations)
                };
                
                // Get actual plan name from tenant - need to load with subscription plan
                if (_subscriptionInfo != null)
                {
                    await DbSync.ExecuteAsync(async () =>
                    {
                        var tenant = await _context.Tenants
                            .Include(t => t.SubscriptionPlan)
                            .FirstOrDefaultAsync(t => t.Id == tenantId);
                        
                        if (tenant?.SubscriptionPlan != null)
                        {
                            _subscriptionInfo.PlanName = tenant.SubscriptionPlan.Name;
                        }
                    });
                }
            }
            else
            {
                // Subscriptions enabled but no plan assigned - show unlimited
                _subscriptionInfo = new SubscriptionInfo
                {
                    PlanName = null,
                    UsersCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Users),
                    DocumentsCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Documents),
                    ChartsCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Charts),
                    ConversationsCurrent = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Conversations)
                };
            }
        }
    }

    private string GetBadgeClass(int current, int max)
    {
        var percentage = (double)current / max;
        return percentage >= 1.0 
            ? "bg-danger" 
            : percentage >= 0.9 
                ? "bg-warning" 
                : "bg-success";
    }

    private async Task LoadEnabledFeaturesAsync(string userId, int tenantId)
    {
        var features = new List<FeatureInfo>();

        // Check if user is Admin
        var isAdmin = false;
        var user = await UserManager.FindByIdAsync(userId);
        if (user != null)
        {
            isAdmin = await UserManager.IsInRoleAsync(user, "Admin");
        }

        // ChatGPT Feature
        if (await FeatureFlagService.IsEnabledAsync("ChatGpt_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "ChatGPT Integration",
                Description = "Leverage AI-powered conversations and document analysis with customizable prompts.",
                Icon = "bi bi-chat-dots",
                Link = "/chatgpt/chat",
                LinkText = "Start Chatting"
            });
        }

        // Documents Feature
        if (await FeatureFlagService.IsEnabledAsync("Documents_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Document Management",
                Description = "Upload, organize, and analyze documents with AI-powered insights.",
                Icon = "bi bi-file-earmark",
                Link = "/documents",
                LinkText = "Browse Documents"
            });
        }

        // Charts Feature
        if (await FeatureFlagService.IsEnabledAsync("Charts_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Data Visualization",
                Description = "Create interactive charts and visualizations from Excel and CSV data.",
                Icon = "bi bi-bar-chart",
                Link = "/charts",
                LinkText = "View Charts"
            });
        }

        // Users Management (Admin or with permission)
        if (await FeatureFlagService.IsEnabledAsync("Users_Enabled"))
        {
            if (isAdmin)
            {
                features.Add(new FeatureInfo
                {
                    Title = "User Management",
                    Description = "Manage users, assign roles, and control access across your organization.",
                    Icon = "bi bi-people",
                    Link = "/admin/users",
                    LinkText = "Manage Users"
                });
            }
        }

        // Roles Management (Admin or with permission)
        if (await FeatureFlagService.IsEnabledAsync("Roles_Enabled"))
        {
            if (isAdmin)
            {
                features.Add(new FeatureInfo
                {
                    Title = "Role Management",
                    Description = "Configure roles and permissions to control access to features and resources.",
                    Icon = "bi bi-shield-check",
                    Link = "/admin/roles",
                    LinkText = "Manage Roles"
                });
            }
        }

        // Stripe Payments
        if (await FeatureFlagService.IsEnabledAsync("Subscriptions"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Payment Management",
                Description = "Manage subscriptions and payments through Stripe integration.",
                Icon = "bi bi-credit-card",
                Link = "/stripe/subscriptions",
                LinkText = "View Payments"
            });
        }

        // Feature Flags Management (Admin only)
        if (isAdmin && await FeatureFlagService.IsEnabledAsync("FeatureFlags_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Feature Settings",
                Description = "Enable or disable application features to customize your workspace.",
                Icon = "bi bi-toggle-on",
                Link = "/admin/feature-settings",
                LinkText = "Configure Features"
            });
        }

        // Migrations (Admin only)
        if (isAdmin && await FeatureFlagService.IsEnabledAsync("Migrations_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Database Migrations",
                Description = "Manage database schema changes and migrations.",
                Icon = "bi bi-database",
                Link = "/superadmin/migrations",
                LinkText = "Manage Migrations"
            });
        }

        // Application Logger
        if (await FeatureFlagService.IsEnabledAsync("Logger_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Application Logger",
                Description = "Monitor application logs and debug issues in real-time.",
                Icon = "bi bi-journal-text",
                Link = null,
                LinkText = "Available"
            });
        }

        _enabledFeatures = features;
    }

    private async Task LoadPublicFeaturesAsync()
    {
        var features = new List<FeatureInfo>();

        // Show public-facing features that don't require authentication
        if (await FeatureFlagService.IsEnabledAsync("ChatGpt_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "ChatGPT Integration",
                Description = "Leverage AI-powered conversations and document analysis.",
                Icon = "bi bi-chat-dots",
                Link = null,
                LinkText = "Sign in to access"
            });
        }

        if (await FeatureFlagService.IsEnabledAsync("Documents_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Document Management",
                Description = "Upload, organize, and analyze documents with AI-powered insights.",
                Icon = "bi bi-file-earmark",
                Link = null,
                LinkText = "Sign in to access"
            });
        }

        if (await FeatureFlagService.IsEnabledAsync("Charts_Enabled"))
        {
            features.Add(new FeatureInfo
            {
                Title = "Data Visualization",
                Description = "Create interactive charts and visualizations from your data.",
                Icon = "bi bi-bar-chart",
                Link = null,
                LinkText = "Sign in to access"
            });
        }

        _enabledFeatures = features;
    }

    private void NavigateToCreateOrganization()
    {
        Navigation.NavigateTo("/tenant/create-organization");
    }
}
