@page "/documents/upload"
@using Blazor_Bedrock.Services.Document
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services.Subscription
@using Blazor_Bedrock.Services.FeatureFlag
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Blazor_Bedrock.Data.Models
@inject IDocumentService DocumentService
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject ISubscriptionLimitationService LimitationService
@inject IFeatureFlagService FeatureFlagService
@rendermode InteractiveServer

<PageTitle>Upload Document - Blazor Bedrock</PageTitle>

<div class="container-fluid mt-4">
    <h4 class="mb-4">Upload Document</h4>
    
    @* Subscription Limitation Counter *@
    @if (_subscriptionsEnabled && _limitations != null)
    {
        <div class="limitation-counter mb-3">
            <div class="d-flex align-items-center">
                <span class="text-muted me-2">
                    <i class="bi bi-info-circle me-1"></i>
                    Documents:
                </span>
                @if (_maxDocuments.HasValue)
                {
                    <span class="@GetBadgeClass()">
                        @_currentDocumentCount / @_maxDocuments
                    </span>
                }
                else
                {
                    <span class="badge bg-success">
                        @_currentDocumentCount (Unlimited)
                    </span>
                }
            </div>
            @if (_maxDocuments.HasValue)
            {
                @if (_currentDocumentCount >= _maxDocuments)
                {
                    <div class="alert alert-warning alert-sm mt-2 mb-0 py-1">
                        <small><i class="bi bi-exclamation-triangle me-1"></i>Limit reached. Upgrade your subscription to add more.</small>
                    </div>
                }
                else if (_currentDocumentCount >= _maxDocuments * 0.9)
                {
                    <div class="alert alert-info alert-sm mt-2 mb-0 py-1">
                        <small><i class="bi bi-info-circle me-1"></i>Approaching limit (@((_maxDocuments - _currentDocumentCount)) remaining).</small>
                    </div>
                }
            }
        </div>
    }
    
    <div class="card shadow">
        <div class="card-body p-4">
        <div class="mb-3">
            <label class="form-label">Select Document</label>
            <InputFile OnChange="HandleFileSelected" class="form-control" accept=".pdf,.doc,.docx,.xlsx,.xls,.csv" />
            @if (selectedFile != null)
            {
                <div class="mt-2">
                    <small class="text-success">
                        âœ“ Selected: @selectedFile.Name (@(selectedFile.Size / 1024) KB)
                    </small>
                </div>
            }
            else
            {
                <div class="mt-2">
                    <small class="text-muted">No file selected</small>
                </div>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">Title (Optional)</label>
            <input type="text" class="form-control" @bind="uploadModel.Title" />
        </div>

        <div class="mb-3">
            <label class="form-label">Author (Optional)</label>
            <input type="text" class="form-control" @bind="uploadModel.Author" />
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (isUploading)
        {
            <div class="alert alert-info">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                Uploading and processing document...
            </div>
        }

        <button type="button" class="btn btn-primary" @onclick="HandleUpload" disabled="@IsUploadButtonDisabled">
            @if (isUploading)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            }
            Upload Document
            @if (selectedFile != null)
            {
                <span class="badge bg-light text-dark ms-2">Ready</span>
            }
        </button>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private UploadModel uploadModel = new();
    private bool isUploading = false;
    private string? errorMessage;
    private string? userId;
    private int? tenantId;
    private bool _subscriptionsEnabled = false;
    private SubscriptionLimitations? _limitations;
    private int _currentDocumentCount = 0;
    private int? _maxDocuments;

    private bool IsUploadButtonDisabled => selectedFile == null || isUploading;

    private class UploadModel
    {
        public string? Title { get; set; }
        public string? Author { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Check if Documents feature is enabled
        var isEnabled = await FeatureFlagService.IsEnabledAsync("Documents_Enabled");
        if (!isEnabled)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        tenantId = TenantService.GetCurrentTenantId();

        if (string.IsNullOrEmpty(userId) || tenantId == null)
        {
            errorMessage = "Unable to identify user or organization.";
        }
        else
        {
            await LoadSubscriptionInfoAsync();
        }
    }

    private async Task LoadSubscriptionInfoAsync()
    {
        if (tenantId.HasValue)
        {
            _subscriptionsEnabled = await FeatureFlagService.IsEnabledAsync("Subscriptions");
            
            if (_subscriptionsEnabled)
            {
                _currentDocumentCount = await LimitationService.GetCurrentCountAsync(tenantId, LimitationType.Documents);
                _limitations = await LimitationService.GetTenantLimitationsAsync(tenantId);
                _maxDocuments = _limitations?.MaxDocuments;
            }
        }
    }

    private string GetBadgeClass()
    {
        if (!_maxDocuments.HasValue) return "badge bg-secondary";
        
        var percentage = (double)_currentDocumentCount / _maxDocuments.Value;
        return percentage >= 1.0 
            ? "badge bg-danger" 
            : percentage >= 0.9 
                ? "badge bg-warning" 
                : "badge bg-success";
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            selectedFile = e.File;
            errorMessage = null;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error selecting file: {ex.Message}";
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleUpload()
    {
        if (selectedFile == null)
        {
            errorMessage = "Please select a file to upload.";
            return;
        }

        if (string.IsNullOrEmpty(userId) || tenantId == null)
        {
            errorMessage = "Unable to identify user or organization.";
            return;
        }

        isUploading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50MB max
            // Handle CSV content type - browsers may not set it correctly
            var contentType = selectedFile.ContentType ?? "application/octet-stream";
            if (selectedFile.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase) && 
                !contentType.Contains("csv", StringComparison.OrdinalIgnoreCase))
            {
                contentType = "text/csv";
            }
            
            var document = await DocumentService.UploadDocumentAsync(
                stream,
                selectedFile.Name,
                contentType,
                userId,
                tenantId.Value,
                uploadModel.Title,
                uploadModel.Author
            );

            NavigationManager.NavigateTo($"/documents/{document.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error uploading document: {ex.Message}";
            if (ex.InnerException != null)
            {
                errorMessage += $" ({ex.InnerException.Message})";
            }
            Console.WriteLine($"Upload error: {ex}");
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }
}
