@page "/tenant/create-organization"
@attribute [Authorize]
@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject INotificationService NotificationService
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

<PageTitle>Create Organization</PageTitle>

<div class="container mt-4" style="max-width: 600px;">
    <h4 class="mb-4">Create Organization</h4>
    
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <strong>Error:</strong> @_errorMessage
            <button type="button" class="btn-close" @onclick="() => _errorMessage = string.Empty" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            @_successMessage
            <button type="button" class="btn-close" @onclick="() => _successMessage = string.Empty" aria-label="Close"></button>
        </div>
    }
    
    <div class="card shadow">
        <div class="card-body p-5">
            <EditForm Model="@_organizationModel" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label for="orgName" class="form-label">Organization Name</label>
                    <input type="text" class="form-control" id="orgName" @bind="_organizationModel.Name" required />
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" rows="3" @bind="_organizationModel.Description"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="domain" class="form-label">Domain (Optional)</label>
                    <input type="text" class="form-control" id="domain" @bind="_organizationModel.Domain" />
                    <div class="form-text">Optional: Your organization's domain name</div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Creating...</span>
                        }
                        else
                        {
                            <span>Create Organization</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private OrganizationModel _organizationModel = new();
    private bool _isLoading = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;
    private string? _userId;

    private class OrganizationModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? Domain { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Get current user ID
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            // If still null, try to get user from UserManager
            if (string.IsNullOrEmpty(_userId))
            {
                await DbSync.ExecuteAsync(async () =>
                {
                    var user = await UserManager.GetUserAsync(authState.User);
                    if (user != null)
                    {
                        _userId = user.Id;
                    }
                });
            }
        }

        if (string.IsNullOrEmpty(_userId))
        {
            _errorMessage = "Unable to identify current user. Please log out and log back in.";
            await NotificationService.ShowErrorAsync(_errorMessage);
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private async Task HandleSubmit()
    {
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(_organizationModel.Name))
        {
            _errorMessage = "Organization name is required.";
            await NotificationService.ShowWarningAsync(_errorMessage);
            return;
        }

        if (string.IsNullOrWhiteSpace(_userId))
        {
            _errorMessage = "User ID is missing. Please log out and log back in.";
            await NotificationService.ShowErrorAsync(_errorMessage);
            return;
        }

        _isLoading = true;

        try
        {
            var tenant = await TenantService.CreateTenantAsync(
                _organizationModel.Name.Trim(), 
                string.IsNullOrWhiteSpace(_organizationModel.Description) ? null : _organizationModel.Description.Trim(),
                string.IsNullOrWhiteSpace(_organizationModel.Domain) ? null : _organizationModel.Domain.Trim(),
                _userId
            );

            if (tenant != null)
            {
                _successMessage = $"Organization '{tenant.Name}' created successfully!";
                await NotificationService.ShowSuccessAsync(_successMessage);
                
                // Wait a moment before navigating to show success message
                await Task.Delay(1500);
                // Force a full page reload to refresh the tenant selector
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                _errorMessage = "Failed to create organization. Please try again.";
                await NotificationService.ShowErrorAsync(_errorMessage);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error creating organization: {ex.Message}";
            await NotificationService.ShowErrorAsync(_errorMessage);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
