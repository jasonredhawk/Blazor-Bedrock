@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MudBlazor
@implements IDisposable
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

@if (_isAuthenticated && _userTenants.Any())
{
    var currentTenant = _userTenants.FirstOrDefault(t => t.Id == _selectedTenantId);
    <MudMenu Icon="@Icons.Material.Filled.Business" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
        <ActivatorContent>
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="mr-2" Style="text-transform: none;">
                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                <MudText Typo="Typo.body1" Class="mr-2">
                    @(currentTenant?.Name ?? "Select Organization")
                </MudText>
                <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" />
            </MudButton>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem>
                <MudText Typo="Typo.body2" Class="px-4 py-2">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" Size="Size.Small" />
                    Organizations
                </MudText>
            </MudMenuItem>
            <MudDivider />
            @foreach (var tenant in _userTenants)
            {
                <MudMenuItem OnClick="() => HandleTenantChange(tenant.Id)" Class="@(tenant.Id == _selectedTenantId ? "mud-primary-text" : "")">
                    <MudIcon Icon="@(tenant.Id == _selectedTenantId ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.RadioButtonUnchecked)" 
                             Size="Size.Small" Class="mr-2" />
                    @tenant.Name
                </MudMenuItem>
            }
            <MudDivider />
            <MudMenuItem OnClick="NavigateToCreateOrganization">
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
                Create New Organization
            </MudMenuItem>
        </ChildContent>
    </MudMenu>
}
else if (_isAuthenticated)
{
    <MudMenu Icon="@Icons.Material.Filled.Business" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
        <ActivatorContent>
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="mr-2" Style="text-transform: none;">
                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                <MudText Typo="Typo.body1" Class="mr-2">
                    No Organization
                </MudText>
                <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" />
            </MudButton>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem OnClick="NavigateToCreateOrganization">
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
                Create Organization
            </MudMenuItem>
        </ChildContent>
    </MudMenu>
}

@code {
    private List<Tenant> _userTenants = new();
    private int? _selectedTenantId;
    private bool _isAuthenticated = false;
    private ApplicationUser? _currentUser;
    private bool _isUpdating = false;

    protected override async Task OnInitializedAsync()
    {
        await UpdateAuthenticationState();
        StateHasChanged();
        
        // Subscribe to authentication state changes
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await UpdateAuthenticationState();
        StateHasChanged();
        await base.OnParametersSetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Subscribe to location changes to refresh tenant list when navigating
            NavigationManager.LocationChanged += OnLocationChanged;
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Refresh tenant list when navigating to ensure it's up to date
        // Only refresh if we're authenticated and not currently updating
        if (!_isUpdating && _isAuthenticated)
        {
            await RefreshTenantList();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> authStateTask)
    {
        await UpdateAuthenticationState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateAuthenticationState()
    {
        // Prevent concurrent execution
        if (_isUpdating)
            return;

        try
        {
            _isUpdating = true;
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;

            if (_isAuthenticated)
            {
                var userId = authState.User!.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (!string.IsNullOrEmpty(userId))
                {
                    // Wrap database operations in sync service
                    await DbSync.ExecuteAsync(async () =>
                    {
                        _currentUser = await UserManager.FindByIdAsync(userId);
                        _userTenants = await TenantService.GetUserTenantsAsync(userId);
                        _selectedTenantId = TenantService.GetCurrentTenantId() ?? _userTenants.FirstOrDefault()?.Id;
                    });
                }
            }
            else
            {
                _userTenants = new List<Tenant>();
                _selectedTenantId = null;
                _currentUser = null;
            }
        }
        catch (Exception ex)
        {
            // Ignore disposed object exceptions - component might be disposing
            if (ex is ObjectDisposedException)
            {
                return;
            }
            _isAuthenticated = false;
            _userTenants = new List<Tenant>();
            _selectedTenantId = null;
            _currentUser = null;
        }
        finally
        {
            _isUpdating = false;
        }
    }

    public void Dispose()
    {
        if (AuthStateProvider != null)
        {
            AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
        if (NavigationManager != null)
        {
            NavigationManager.LocationChanged -= OnLocationChanged;
        }
    }

    private async Task HandleTenantChange(int tenantId)
    {
        if (_selectedTenantId == tenantId)
        {
            return; // Already selected
        }

        try
        {
            var success = await TenantService.SetCurrentTenantAsync(tenantId);
            
            if (success)
            {
                _selectedTenantId = tenantId;
                await InvokeAsync(StateHasChanged);
                
                // Refresh the page to update tenant context
                await Task.Delay(100);
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            else
            {
                Snackbar.Add("Failed to switch organization. You may not have access to this organization.", Severity.Error);
                // Refresh tenant list in case something changed
                await RefreshTenantList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error switching organization: {ex.Message}", Severity.Error);
        }
    }

    private async Task RefreshTenantList()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                await DbSync.ExecuteAsync(async () =>
                {
                    _userTenants = await TenantService.GetUserTenantsAsync(userId);
                    _selectedTenantId = TenantService.GetCurrentTenantId() ?? _userTenants.FirstOrDefault()?.Id;
                });
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void NavigateToCreateOrganization()
    {
        NavigationManager.NavigateTo("/tenant/create-organization");
    }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;
}