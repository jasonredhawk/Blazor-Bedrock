@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MudBlazor
@implements IDisposable
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@rendermode InteractiveServer

@if (_isAuthenticated && _userTenants.Any())
{
    var currentTenant = _userTenants.FirstOrDefault(t => t.Id == _selectedTenantId);
    <MudSelect @bind-Value="_selectedTenantId" 
               Variant="Variant.Text"
               Dense="true"
               Class="mr-4"
               Style="min-width: 180px; max-width: 250px;"
               OnSelectionChanged="HandleTenantChange">
        <ActivatorContent>
            <MudText Typo="Typo.body2" Class="mr-2">
                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                @(currentTenant?.Name ?? "Select Organization")
            </MudText>
        </ActivatorContent>
        @foreach (var tenant in _userTenants)
        {
            <MudSelectItem Value="@tenant.Id">@tenant.Name</MudSelectItem>
        }
    </MudSelect>
}
else if (_isAuthenticated)
{
    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Class="mr-4">
        <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
        <MudText Typo="Typo.caption">No Organization</MudText>
    </MudChip>
}

@code {
    private List<Tenant> _userTenants = new();
    private int? _selectedTenantId;
    private bool _isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        await UpdateAuthenticationState();
        
        // Subscribe to authentication state changes
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> authStateTask)
    {
        await UpdateAuthenticationState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateAuthenticationState()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;

        if (_isAuthenticated)
        {
            var userId = authState.User!.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                _userTenants = await TenantService.GetUserTenantsAsync(userId);
                _selectedTenantId = TenantService.GetCurrentTenantId() ?? _userTenants.FirstOrDefault()?.Id;
            }
        }
        else
        {
            _userTenants = new List<Tenant>();
            _selectedTenantId = null;
        }
    }

    public void Dispose()
    {
        if (AuthStateProvider != null)
        {
            AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
    }

    private async Task HandleTenantChange(int? tenantId)
    {
        if (tenantId.HasValue && _selectedTenantId != tenantId)
        {
            await TenantService.SetCurrentTenantAsync(tenantId.Value);
            _selectedTenantId = tenantId;
            // Refresh the page to update tenant context
            await Task.Delay(100);
        }
    }
}

