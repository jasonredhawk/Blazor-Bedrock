@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MudBlazor
@implements IDisposable
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

@if (_isAuthenticated && _userTenants.Any())
{
    var currentTenant = _userTenants.FirstOrDefault(t => t.Id == _selectedTenantId);
    <MudMenu Icon="@Icons.Material.Filled.Business" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
        <ActivatorContent>
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="mr-2" Style="text-transform: none;">
                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                <MudText Typo="Typo.body1" Class="mr-2">
                    @(currentTenant?.Name ?? "Select Organization")
                </MudText>
                <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" />
            </MudButton>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem>
                <MudText Typo="Typo.body2" Class="px-4 py-2">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" Size="Size.Small" />
                    Organizations
                </MudText>
            </MudMenuItem>
            <MudDivider />
            @foreach (var tenant in _userTenants)
            {
                <MudMenuItem OnClick="() => HandleTenantChange(tenant.Id)" Class="@(tenant.Id == _selectedTenantId ? "mud-primary-text" : "")">
                    <MudIcon Icon="@(tenant.Id == _selectedTenantId ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.RadioButtonUnchecked)" 
                             Size="Size.Small" Class="mr-2" />
                    @tenant.Name
                </MudMenuItem>
            }
            <MudDivider />
            <MudMenuItem OnClick="ShowCreateOrganizationDialog">
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
                Create New Organization
            </MudMenuItem>
        </ChildContent>
    </MudMenu>
}
else if (_isAuthenticated)
{
    <MudMenu Icon="@Icons.Material.Filled.Business" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
        <ActivatorContent>
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="mr-2" Style="text-transform: none;">
                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                <MudText Typo="Typo.body1" Class="mr-2">
                    No Organization
                </MudText>
                <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" />
            </MudButton>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem OnClick="ShowCreateOrganizationDialog">
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
                Create Organization
            </MudMenuItem>
        </ChildContent>
    </MudMenu>
}

@code {
    private List<Tenant> _userTenants = new();
    private int? _selectedTenantId;
    private bool _isAuthenticated = false;
    private ApplicationUser? _currentUser;
    private bool _isUpdating = false;

    protected override async Task OnInitializedAsync()
    {
        await UpdateAuthenticationState();
        StateHasChanged();
        
        // Subscribe to authentication state changes
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await UpdateAuthenticationState();
        StateHasChanged();
        await base.OnParametersSetAsync();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> authStateTask)
    {
        await UpdateAuthenticationState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateAuthenticationState()
    {
        // Prevent concurrent execution
        if (_isUpdating)
            return;

        try
        {
            _isUpdating = true;
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;

            if (_isAuthenticated)
            {
                var userId = authState.User!.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (!string.IsNullOrEmpty(userId))
                {
                    // Wrap database operations in sync service
                    await DbSync.ExecuteAsync(async () =>
                    {
                        _currentUser = await UserManager.FindByIdAsync(userId);
                        _userTenants = await TenantService.GetUserTenantsAsync(userId);
                        _selectedTenantId = TenantService.GetCurrentTenantId() ?? _userTenants.FirstOrDefault()?.Id;
                    });
                }
            }
            else
            {
                _userTenants = new List<Tenant>();
                _selectedTenantId = null;
                _currentUser = null;
            }
        }
        catch (Exception ex)
        {
            // Ignore disposed object exceptions - component might be disposing
            if (ex is ObjectDisposedException)
            {
                return;
            }
            _isAuthenticated = false;
            _userTenants = new List<Tenant>();
            _selectedTenantId = null;
            _currentUser = null;
        }
        finally
        {
            _isUpdating = false;
        }
    }

    public void Dispose()
    {
        if (AuthStateProvider != null)
        {
            AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
    }

    private async Task HandleTenantChange(int tenantId)
    {
        if (_selectedTenantId != tenantId)
        {
            await TenantService.SetCurrentTenantAsync(tenantId);
            _selectedTenantId = tenantId;
            await InvokeAsync(StateHasChanged);
            // Refresh the page to update tenant context
            await Task.Delay(100);
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
    }

    private async Task ShowCreateOrganizationDialog()
    {
        if (_currentUser == null)
        {
            Snackbar.Add("Unable to identify current user. Please log out and log back in.", Severity.Error);
            return;
        }

        var parameters = new DialogParameters
        {
            ["UserId"] = _currentUser.Id
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<CreateOrganizationDialog>("Create Organization", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is Tenant createdTenant)
        {
            // Refresh tenant list
            if (!string.IsNullOrEmpty(_currentUser.Id))
            {
                _userTenants = await TenantService.GetUserTenantsAsync(_currentUser.Id);
                _selectedTenantId = createdTenant.Id;
                await InvokeAsync(StateHasChanged);
                Snackbar.Add($"Organization '{createdTenant.Name}' created successfully!", Severity.Success);
                // Refresh the page to update tenant context
                await Task.Delay(100);
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
        }
    }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;
}