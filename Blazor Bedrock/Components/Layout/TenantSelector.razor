@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@implements IDisposable
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject INotificationService NotificationService
@inject IDatabaseSyncService DbSync
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

@if (_isAuthenticated && _userTenants.Any())
{
    var currentTenant = _userTenants.FirstOrDefault(t => t.Id == _selectedTenantId);
    <div class="nav-item dropdown">
        <a class="nav-link dropdown-toggle text-white" href="#" id="tenantMenuDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-building me-1"></i>
            @(currentTenant?.Name ?? "Select Organization")
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="tenantMenuDropdown">
            <li>
                <h6 class="dropdown-header">
                    <i class="bi bi-building me-2"></i>
                    Organizations
                </h6>
            </li>
            <li><hr class="dropdown-divider"></li>
            @foreach (var tenant in _userTenants)
            {
                <li>
                    <a class="dropdown-item @(tenant.Id == _selectedTenantId ? "active" : "")" href="#" @onclick="() => HandleTenantChange(tenant.Id)">
                        <i class="bi @(tenant.Id == _selectedTenantId ? "bi-check-circle-fill" : "bi-circle") me-2"></i>
                        @tenant.Name
                    </a>
                </li>
            }
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="/tenant/create-organization" @onclick="NavigateToCreateOrganization">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create New Organization
                </a>
            </li>
        </ul>
    </div>
}
else if (_isAuthenticated)
{
    <div class="nav-item dropdown">
        <a class="nav-link dropdown-toggle text-white" href="#" id="tenantMenuDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-building me-1"></i>
            No Organization
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="tenantMenuDropdown">
            <li>
                <a class="dropdown-item" href="/tenant/create-organization" @onclick="NavigateToCreateOrganization">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create Organization
                </a>
            </li>
        </ul>
    </div>
}

@code {
    private List<Tenant> _userTenants = new();
    private int? _selectedTenantId;
    private bool _isAuthenticated = false;
    private ApplicationUser? _currentUser;
    private bool _isUpdating = false;

    protected override async Task OnInitializedAsync()
    {
        await UpdateAuthenticationState();
        StateHasChanged();
        
        // Subscribe to authentication state changes
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await UpdateAuthenticationState();
        StateHasChanged();
        await base.OnParametersSetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Subscribe to location changes to refresh tenant list when navigating
            NavigationManager.LocationChanged += OnLocationChanged;
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Refresh tenant list when navigating to ensure it's up to date
        // Only refresh if we're authenticated and not currently updating
        if (!_isUpdating && _isAuthenticated)
        {
            await RefreshTenantList();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> authStateTask)
    {
        await UpdateAuthenticationState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateAuthenticationState()
    {
        // Prevent concurrent execution
        if (_isUpdating)
            return;

        try
        {
            _isUpdating = true;
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;

            if (_isAuthenticated)
            {
                var userId = authState.User!.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (!string.IsNullOrEmpty(userId))
                {
                    // Wrap database operations in sync service
                    await DbSync.ExecuteAsync(async () =>
                    {
                        _currentUser = await UserManager.FindByIdAsync(userId);
                        _userTenants = await TenantService.GetUserTenantsAsync(userId);
                        _selectedTenantId = TenantService.GetCurrentTenantId() ?? _userTenants.FirstOrDefault()?.Id;
                    });
                }
            }
            else
            {
                _userTenants = new List<Tenant>();
                _selectedTenantId = null;
                _currentUser = null;
            }
        }
        catch (Exception ex)
        {
            // Ignore disposed object exceptions - component might be disposing
            if (ex is ObjectDisposedException)
            {
                return;
            }
            _isAuthenticated = false;
            _userTenants = new List<Tenant>();
            _selectedTenantId = null;
            _currentUser = null;
        }
        finally
        {
            _isUpdating = false;
        }
    }

    public void Dispose()
    {
        if (AuthStateProvider != null)
        {
            AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
        if (NavigationManager != null)
        {
            NavigationManager.LocationChanged -= OnLocationChanged;
        }
    }

    private async Task HandleTenantChange(int tenantId)
    {
        if (_selectedTenantId == tenantId)
        {
            return; // Already selected
        }

        try
        {
            var success = await TenantService.SetCurrentTenantAsync(tenantId);
            
            if (success)
            {
                _selectedTenantId = tenantId;
                await InvokeAsync(StateHasChanged);
                
                // Refresh the page to update tenant context
                await Task.Delay(100);
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            else
            {
                await NotificationService.ShowErrorAsync("Failed to switch organization. You may not have access to this organization.");
                // Refresh tenant list in case something changed
                await RefreshTenantList();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"Error switching organization: {ex.Message}");
        }
    }

    private async Task RefreshTenantList()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                await DbSync.ExecuteAsync(async () =>
                {
                    _userTenants = await TenantService.GetUserTenantsAsync(userId);
                    _selectedTenantId = TenantService.GetCurrentTenantId() ?? _userTenants.FirstOrDefault()?.Id;
                });
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void NavigateToCreateOrganization()
    {
        NavigationManager.NavigateTo("/tenant/create-organization");
    }
}
