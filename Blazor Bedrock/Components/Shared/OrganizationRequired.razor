@using Blazor_Bedrock.Services.Tenant
@using Blazor_Bedrock.Services
@using Blazor_Bedrock.Services.Navigation
@using Blazor_Bedrock.Components.Layout
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Blazor_Bedrock.Data.Models
@inject ITenantService TenantService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ISafeNavigationService SafeNavigation
@inject INotificationService NotificationService
@inject IDatabaseSyncService DbSync
@rendermode InteractiveServer

@if (_showPrompt)
{
    <div class="container mt-5" style="max-width: 600px;">
        <div class="card shadow">
            <div class="card-body p-5">
                <h4 class="mb-4">Organization Required</h4>
                <p class="mb-4">
                    You need to create an organization to access the application features. 
                    Please create an organization to continue.
                </p>
                <button class="btn btn-primary mt-4" @onclick="NavigateToCreateOrganization">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create Organization
                </button>
            </div>
        </div>
    </div>
}
else
{
    @ChildContent
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    private bool _showPrompt = false;
    private bool _isChecking = true;

    protected override async Task OnInitializedAsync()
    {
        await CheckOrganizationAsync();
    }

    private async Task CheckOrganizationAsync()
    {
        // Skip check for auth pages and create organization page
        var currentPath = Navigation.Uri.Replace(Navigation.BaseUri, "").TrimStart('/');
        if (currentPath.StartsWith("auth/", StringComparison.OrdinalIgnoreCase) || 
            currentPath.StartsWith("tenant/create-organization", StringComparison.OrdinalIgnoreCase))
        {
            _isChecking = false;
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated != true)
        {
            _isChecking = false;
            return;
        }

        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrEmpty(userId))
        {
            var user = await UserManager.GetUserAsync(authState.User);
            userId = user?.Id;
        }

        if (!string.IsNullOrEmpty(userId))
        {
            var tenants = await TenantService.GetUserTenantsAsync(userId);
            var currentTenantId = TenantService.GetCurrentTenantId();
            
            // If no tenants or no current tenant selected, show prompt
            if (!tenants.Any() || !currentTenantId.HasValue)
            {
                _showPrompt = true;
            }
        }

        _isChecking = false;
    }

    private void NavigateToCreateOrganization()
    {
        SafeNavigation.NavigateTo("/tenant/create-organization");
    }
}
