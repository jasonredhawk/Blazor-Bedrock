@using Blazor_Bedrock.Services.Logger
@using Microsoft.JSInterop
@inject IApplicationLoggerService LoggerService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@rendermode InteractiveServer

@if (_isVisible)
{
    <div class="application-logger border-top bg-white shadow-lg" style="@GetLoggerStyle()">
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <span class="ms-2">Application Logger (@_logs.Count)</span>
            <div>
                <button class="btn btn-sm btn-outline-primary me-1" @onclick="ToggleFilter" title="Toggle Filter">
                    <i class="bi bi-funnel @(_showFilter ? "text-primary" : "")"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary me-1" @onclick="ToggleExpanded" title="Toggle Expand">
                    <i class="bi bi-chevron-@(_isExpanded ? "down" : "up")"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning me-1" @onclick="ClearLogs" title="Clear Logs">
                    <i class="bi bi-trash"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" @onclick="HideLogger" title="Hide Logger">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        
        @if (_showFilter)
        {
            <div class="d-flex align-items-center p-2 border-bottom gap-2">
                <div style="width: 150px;">
                    <select class="form-select form-select-sm" @bind="_selectedLevel">
                        <option value="">All</option>
                        <option value="@LogLevel.Information">Information</option>
                        <option value="@LogLevel.Warning">Warning</option>
                        <option value="@LogLevel.Error">Error</option>
                        <option value="@LogLevel.Debug">Debug</option>
                    </select>
                </div>
                <div class="input-group input-group-sm" style="width: 200px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search" @bind="_searchText" @bind:event="oninput" />
                </div>
            </div>
        }
        
        @if (_isExpanded)
        {
            <div style="height: calc(100% - 100px); overflow-y: auto;">
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-striped mb-0">
                        <colgroup>
                            <col style="width: 150px;" />
                            <col style="width: 100px;" />
                            <col style="width: 150px;" />
                            <col />
                        </colgroup>
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Category</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in FilteredLogs)
                            {
                                <tr>
                                    <td>@log.Timestamp.ToString("HH:mm:ss.fff")</td>
                                    <td>
                                        <span class="badge @GetLevelBadgeClass(log.Level)">@log.Level</span>
                                    </td>
                                    <td>@log.Category</td>
                                    <td>
                                        <div>@log.Message</div>
                                        @if (!string.IsNullOrEmpty(log.Exception))
                                        {
                                            <details class="mt-1">
                                                <summary class="text-muted small">Exception Details</summary>
                                                <pre class="small bg-light p-2 mt-1 mb-0" style="white-space: pre-wrap; font-family: monospace;">@log.Exception</pre>
                                            </details>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool _isVisible = false;
    private bool _isExpanded = false;
    private bool _showFilter = false;
    private List<LogEntry> _logs = new();
    private LogLevel? _selectedLevel = null;
    private string _searchText = string.Empty;
    private DotNetObjectReference<ApplicationLogger>? _objRef;

    private IEnumerable<LogEntry> FilteredLogs
    {
        get
        {
            var filtered = _logs.AsEnumerable();
            
            if (_selectedLevel.HasValue)
            {
                filtered = filtered.Where(l => l.Level == _selectedLevel.Value);
            }
            
            if (!string.IsNullOrEmpty(_searchText))
            {
                var search = _searchText.ToLower();
                filtered = filtered.Where(l => 
                    l.Message.ToLower().Contains(search) ||
                    l.Category.ToLower().Contains(search));
            }
            
            return filtered.OrderByDescending(l => l.Timestamp);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("applicationLogger.init", _objRef);
            LoggerService.OnLogAdded += RefreshLogs;
            RefreshLogs();
        }
    }

    private void RefreshLogs()
    {
        _logs = LoggerService.GetLogs();
        InvokeAsync(StateHasChanged);
    }

    private void ToggleExpanded()
    {
        _isExpanded = !_isExpanded;
    }

    private void ToggleFilter()
    {
        _showFilter = !_showFilter;
    }

    private void ClearLogs()
    {
        LoggerService.Clear();
        RefreshLogs();
    }

    private void HideLogger()
    {
        _isVisible = false;
    }

    [JSInvokable]
    public void ShowLogger()
    {
        _isVisible = true;
        InvokeAsync(StateHasChanged);
    }

    private string GetLevelBadgeClass(LogLevel level)
    {
        return level switch
        {
            LogLevel.Information => "bg-info",
            LogLevel.Warning => "bg-warning",
            LogLevel.Error => "bg-danger",
            LogLevel.Debug => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private string GetLoggerStyle()
    {
        var height = _isExpanded ? "400px" : "50px";
        return $"position: fixed; bottom: 0; left: 0; right: 0; height: {height}; z-index: 9999;";
    }

    public async ValueTask DisposeAsync()
    {
        LoggerService.OnLogAdded -= RefreshLogs;
        _objRef?.Dispose();
    }
}
