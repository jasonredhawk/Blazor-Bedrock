@using Blazor_Bedrock.Services.Logger
@using Blazor_Bedrock.Services.FeatureFlag
@using Microsoft.JSInterop
@inject IApplicationLoggerService LoggerService
@inject IFeatureFlagService FeatureFlagService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@rendermode InteractiveServer

@if (_isVisible)
{
    <div class="application-logger border-top bg-white shadow-lg flex-shrink-0" 
         style="height: @GetLoggerHeight(); --logger-height: @GetLoggerHeight();">
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <span class="ms-2">Application Logger (@FilteredLogs.Count() of @_logs.Count)</span>
            <div>
                <button class="btn btn-sm btn-outline-primary me-1" @onclick="ToggleFilter" title="Toggle Filter">
                    <i class="bi bi-funnel @(_showFilter ? "text-primary" : "")"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary me-1" @onclick="ToggleExpanded" title="Toggle Expand">
                    <i class="bi bi-chevron-@(_isExpanded ? "down" : "up")"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" @onclick="ClearLogs" title="Clear Logs">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        
        @if (_showFilter)
        {
            <div class="p-2 border-bottom">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <label class="small fw-bold">Log Levels:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-trace" checked="@_enabledLevels[LogLevel.Trace]" @onchange="@((e) => ToggleLevel(LogLevel.Trace, (bool)e.Value!))" />
                            <label class="form-check-label small" for="filter-trace">Trace</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-debug" checked="@_enabledLevels[LogLevel.Debug]" @onchange="@((e) => ToggleLevel(LogLevel.Debug, (bool)e.Value!))" />
                            <label class="form-check-label small" for="filter-debug">Debug</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-information" checked="@_enabledLevels[LogLevel.Information]" @onchange="@((e) => ToggleLevel(LogLevel.Information, (bool)e.Value!))" />
                            <label class="form-check-label small" for="filter-information">Information</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-warning" checked="@_enabledLevels[LogLevel.Warning]" @onchange="@((e) => ToggleLevel(LogLevel.Warning, (bool)e.Value!))" />
                            <label class="form-check-label small" for="filter-warning">Warning</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-error" checked="@_enabledLevels[LogLevel.Error]" @onchange="@((e) => ToggleLevel(LogLevel.Error, (bool)e.Value!))" />
                            <label class="form-check-label small" for="filter-error">Error</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="filter-critical" checked="@_enabledLevels[LogLevel.Critical]" @onchange="@((e) => ToggleLevel(LogLevel.Critical, (bool)e.Value!))" />
                            <label class="form-check-label small" for="filter-critical">Critical</label>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="input-group input-group-sm" style="width: 300px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search logs..." @bind="_searchText" @bind:event="oninput" />
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="SelectAllLevels">All</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="DeselectAllLevels">None</button>
                </div>
            </div>
        }
        
        @if (_isExpanded)
        {
            <div style="height: 400px; overflow-y: auto;">
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-striped mb-0">
                        <colgroup>
                            <col style="width: 150px;" />
                            <col style="width: 100px;" />
                            <col style="width: 150px;" />
                            <col />
                        </colgroup>
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Category</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in FilteredLogs)
                            {
                                <tr>
                                    <td>@log.Timestamp.ToString("HH:mm:ss.fff")</td>
                                    <td>
                                        <span class="badge @GetLevelBadgeClass(log.Level)">@log.Level</span>
                                    </td>
                                    <td>@log.Category</td>
                                    <td>
                                        <div>@log.Message</div>
                                        @if (!string.IsNullOrEmpty(log.Exception))
                                        {
                                            <details class="mt-1">
                                                <summary class="text-muted small">Exception Details</summary>
                                                <pre class="small bg-light p-2 mt-1 mb-0" style="white-space: pre-wrap; font-family: monospace;">@log.Exception</pre>
                                            </details>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool _isLoggerEnabled = true;
    private bool _isVisible = true; // Always visible when feature is enabled
    private bool _isExpanded = false; // Minimized by default
    private bool _showFilter = false;
    private List<LogEntry> _logs = new();
    private Dictionary<LogLevel, bool> _enabledLevels = new()
    {
        { LogLevel.Trace, true },
        { LogLevel.Debug, true },
        { LogLevel.Information, true },
        { LogLevel.Warning, true },
        { LogLevel.Error, true },
        { LogLevel.Critical, true },
        { LogLevel.None, false }
    };
    private string _searchText = string.Empty;

    private IEnumerable<LogEntry> FilteredLogs
    {
        get
        {
            var filtered = _logs.AsEnumerable();
            
            // Filter by enabled log levels
            filtered = filtered.Where(l => _enabledLevels.ContainsKey(l.Level) && _enabledLevels[l.Level]);
            
            // Filter by search text
            if (!string.IsNullOrEmpty(_searchText))
            {
                var search = _searchText.ToLower();
                filtered = filtered.Where(l => 
                    l.Message.ToLower().Contains(search) ||
                    l.Category.ToLower().Contains(search) ||
                    (!string.IsNullOrEmpty(l.Exception) && l.Exception.ToLower().Contains(search)));
            }
            
            return filtered.OrderByDescending(l => l.Timestamp);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Check if logger feature is enabled
        _isLoggerEnabled = await FeatureFlagService.IsEnabledAsync("Logger_Enabled");
        _isVisible = _isLoggerEnabled; // Only visible if feature is enabled
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            LoggerService.OnLogAdded += RefreshLogs;
            RefreshLogs();
        }
        
        // Always update CSS variable on document root so it's accessible everywhere
        // This ensures it's updated whenever the component re-renders
        // This handles: feature disabled (0px), minimized (50px), or expanded (450px/550px)
        await UpdateLoggerHeightVariable();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // Re-check feature flag when parameters change (e.g., after navigation)
        var wasEnabled = _isLoggerEnabled;
        _isLoggerEnabled = await FeatureFlagService.IsEnabledAsync("Logger_Enabled");
        _isVisible = _isLoggerEnabled;
        
        // If feature state changed, update the CSS variable
        if (wasEnabled != _isLoggerEnabled)
        {
            await UpdateLoggerHeightVariable();
        }
    }

    private void RefreshLogs()
    {
        _logs = LoggerService.GetLogs();
        InvokeAsync(StateHasChanged);
    }

    private async Task ToggleExpanded()
    {
        _isExpanded = !_isExpanded;
        StateHasChanged();
        await Task.Delay(10); // Small delay to ensure state is updated
        await UpdateLoggerHeightVariable();
    }

    private async Task ToggleFilter()
    {
        _showFilter = !_showFilter;
        StateHasChanged();
        await Task.Delay(10); // Small delay to ensure state is updated
        await UpdateLoggerHeightVariable();
    }
    
    private async Task UpdateLoggerHeightVariable()
    {
        // If logger feature is disabled or not visible, set height to 0
        var height = (_isLoggerEnabled && _isVisible) ? GetLoggerHeight() : "0px";
        await JSRuntime.InvokeVoidAsync("applicationLogger.setLoggerHeight", height);
    }

    private void SelectAllLevels()
    {
        foreach (var level in _enabledLevels.Keys.ToList())
        {
            if (level != LogLevel.None)
            {
                _enabledLevels[level] = true;
            }
        }
    }

    private void DeselectAllLevels()
    {
        foreach (var level in _enabledLevels.Keys.ToList())
        {
            _enabledLevels[level] = false;
        }
    }

    private void ToggleLevel(LogLevel level, bool enabled)
    {
        if (_enabledLevels.ContainsKey(level))
        {
            _enabledLevels[level] = enabled;
        }
    }

    private void ClearLogs()
    {
        LoggerService.Clear();
        RefreshLogs();
    }

    private string GetLevelBadgeClass(LogLevel level)
    {
        return level switch
        {
            LogLevel.Trace => "bg-secondary text-white",
            LogLevel.Debug => "bg-secondary text-white",
            LogLevel.Information => "bg-info text-white",
            LogLevel.Warning => "bg-warning text-dark",
            LogLevel.Error => "bg-danger text-white",
            LogLevel.Critical => "bg-dark text-white",
            _ => "bg-secondary text-white"
        };
    }

    private string GetLoggerHeight()
    {
        // Minimized: just the header bar
        if (!_isExpanded)
        {
            return "50px";
        }
        
        // Expanded: header + filter (if shown) + content area
        // Header: ~50px, Filter: ~100px (if shown), Content: 400px
        if (_showFilter)
        {
            return "550px"; // 50px header + 100px filter + 400px content
        }
        return "450px"; // 50px header + 400px content
    }

    public async ValueTask DisposeAsync()
    {
        LoggerService.OnLogAdded -= RefreshLogs;
    }
}
